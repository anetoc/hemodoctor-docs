# 07_normalization_heuristics.yaml
# Heur√≠sticas de Normaliza√ß√£o de Unidades - Camada A (Ingestion)
# Vers√£o: v1.0.0
# Data: 2025-10-19

version: normalization_heuristics_v1.0.0

# =============================================================================
# NORMALIZA√á√ÉO DE UNIDADES (Ajustes Dr. Abel Costa 2025-10-19)
# =============================================================================
unit_normalization:
  enabled: true
  audit_log_conversions: true        # Rastreabilidade LGPD/IEC 62304
  fail_safe_mode: true               # Nunca recusar caso; alertar se convers√£o falhar
  
  # ===========================================================================
  # HEUR√çSTICA POR SITE (Learning-Based)
  # ===========================================================================
  site_specific:
    enabled: true
    storage: "site_unit_profiles.json"
    update_policy: "quarterly"
    learning_algorithm: "median-based_detection"
    
    description: |
      Sistema aprende o padr√£o de unidades de cada site (hospital/laborat√≥rio) ao longo do tempo.
      Ap√≥s N casos (default: 100), estabelece perfil do site e aplica convers√£o autom√°tica.
    
    profile_structure:
      site_id: "string (hash SHA256 do site)"
      case_count: "int (n√∫mero de casos processados)"
      learned_units:
        wbc: "1e9/L OR /ŒºL"
        plt: "1e9/L OR /ŒºL"
        anc: "1e9/L OR /ŒºL"
        hb: "g/dL OR g/L OR mmol/L"
      confidence: "float 0-1 (confian√ßa no perfil aprendido)"
      last_updated: "ISO8601 datetime"
    
    bootstrap_threshold: 100          # M√≠nimo de casos para estabelecer perfil
    confidence_threshold: 0.80        # Confian√ßa m√≠nima para aplicar convers√£o autom√°tica
  
  # ===========================================================================
  # DETEC√á√ÉO AUTOM√ÅTICA (p50>1000 ‚Üí dividir por 1000)
  # ===========================================================================
  auto_detection:
    enabled: true
    method: "median_percentile"      # Usa p50 (mediana) de batch para detectar unidade
    batch_size: 50                    # M√≠nimo de casos para calcular p50
    fallback_single_case: true        # Se batch<50, usar regra heur√≠stica simples
    
    rules:
      # WBC (Leuc√≥citos)
      - field: "wbc"
        condition: "p50(wbc) > 1000"
        action: "divide_by_1000"
        converted_unit: "1e9/L"
        original_unit_inferred: "/ŒºL"
        log_message: "WBC em /ŒºL convertido para √ó10‚Åπ/L (p50={p50_value:.1f})"
        confidence_threshold: 0.90
        
        fallback_single_case:
          condition: "value > 200"
          action: "divide_by_1000"
          reason: "WBC fisiologicamente imposs√≠vel >200√ó10‚Åπ/L; assumido /ŒºL"
      
      # PLT (Plaquetas)
      - field: "plt"
        condition: "p50(plt) > 1000"
        action: "divide_by_1000"
        converted_unit: "1e9/L"
        original_unit_inferred: "/ŒºL"
        log_message: "PLT em /ŒºL convertido para √ó10‚Åπ/L (p50={p50_value:.1f})"
        confidence_threshold: 0.90
        
        fallback_single_case:
          condition: "value > 2000"
          action: "divide_by_1000"
          reason: "PLT fisiologicamente imposs√≠vel >2000√ó10‚Åπ/L; assumido /ŒºL"
      
      # ANC (Neutr√≥filos absolutos)
      - field: "anc"
        condition: "p50(anc) > 1000"
        action: "divide_by_1000"
        converted_unit: "1e9/L"
        original_unit_inferred: "/ŒºL"
        log_message: "ANC em /ŒºL convertido para √ó10‚Åπ/L (p50={p50_value:.1f})"
        confidence_threshold: 0.90
        
        fallback_single_case:
          condition: "value > 50"
          action: "divide_by_1000"
          reason: "ANC fisiologicamente improv√°vel >50√ó10‚Åπ/L; assumido /ŒºL"
      
      # Linf√≥citos absolutos
      - field: "lymphocytes_abs"
        condition: "p50(lymphocytes_abs) > 1000"
        action: "divide_by_1000"
        converted_unit: "1e9/L"
        original_unit_inferred: "/ŒºL"
        log_message: "Linf√≥citos em /ŒºL convertidos para √ó10‚Åπ/L (p50={p50_value:.1f})"
        confidence_threshold: 0.85
        
        fallback_single_case:
          condition: "value > 50"
          action: "divide_by_1000"
          reason: "Linf√≥citos fisiologicamente improv√°vel >50√ó10‚Åπ/L; assumido /ŒºL"
      
      # Eosin√≥filos absolutos
      - field: "eosinophils_abs"
        condition: "p50(eosinophils_abs) > 1000"
        action: "divide_by_1000"
        converted_unit: "1e9/L"
        original_unit_inferred: "/ŒºL"
        log_message: "Eosin√≥filos em /ŒºL convertidos para √ó10‚Åπ/L"
        confidence_threshold: 0.80
      
      # Bas√≥filos absolutos
      - field: "basophils_abs"
        condition: "p50(basophils_abs) > 1000"
        action: "divide_by_1000"
        converted_unit: "1e9/L"
        original_unit_inferred: "/ŒºL"
        log_message: "Bas√≥filos em /ŒºL convertidos para √ó10‚Åπ/L"
        confidence_threshold: 0.80
      
      # Mon√≥citos absolutos
      - field: "monocytes_abs"
        condition: "p50(monocytes_abs) > 1000"
        action: "divide_by_1000"
        converted_unit: "1e9/L"
        original_unit_inferred: "/ŒºL"
        log_message: "Mon√≥citos em /ŒºL convertidos para √ó10‚Åπ/L"
        confidence_threshold: 0.80
  
  # ===========================================================================
  # MAPEAMENTO DE UNIDADES CONHECIDAS (Explicit Conversion)
  # ===========================================================================
  known_units:
    # WBC (Leuc√≥citos)
    wbc:
      - from: "/ŒºL"
        to: "1e9/L"
        factor: 0.001
        description: "Convers√£o /ŒºL ‚Üí √ó10‚Åπ/L"
      
      - from: "K/ŒºL"
        to: "1e9/L"
        factor: 1.0
        description: "K/ŒºL (mil/ŒºL) equivalente a √ó10‚Åπ/L"
      
      - from: "10^3/ŒºL"
        to: "1e9/L"
        factor: 1.0
        description: "10¬≥/ŒºL equivalente a √ó10‚Åπ/L"
      
      - from: "cells/ŒºL"
        to: "1e9/L"
        factor: 0.001
        description: "c√©lulas/ŒºL ‚Üí √ó10‚Åπ/L"
      
      - from: "1e6/L"
        to: "1e9/L"
        factor: 0.001
        description: "√ó10‚Å∂/L ‚Üí √ó10‚Åπ/L (raro, mas poss√≠vel)"
    
    # PLT (Plaquetas)
    plt:
      - from: "/ŒºL"
        to: "1e9/L"
        factor: 0.001
        description: "Convers√£o /ŒºL ‚Üí √ó10‚Åπ/L"
      
      - from: "K/ŒºL"
        to: "1e9/L"
        factor: 1.0
        description: "K/ŒºL (mil/ŒºL) equivalente a √ó10‚Åπ/L"
      
      - from: "10^3/ŒºL"
        to: "1e9/L"
        factor: 1.0
        description: "10¬≥/ŒºL equivalente a √ó10‚Åπ/L"
      
      - from: "cells/ŒºL"
        to: "1e9/L"
        factor: 0.001
        description: "c√©lulas/ŒºL ‚Üí √ó10‚Åπ/L"
    
    # Hb (Hemoglobina)
    hb:
      - from: "g/L"
        to: "g/dL"
        factor: 0.1
        description: "Convers√£o g/L ‚Üí g/dL (sistema SI ‚Üí US)"
      
      - from: "mmol/L"
        to: "g/dL"
        factor: 1.61
        description: "mmol/L ‚Üí g/dL (1 mmol/L Hb ‚âà 1.61 g/dL)"
      
      - from: "mg/dL"
        to: "g/dL"
        factor: 0.001
        description: "mg/dL ‚Üí g/dL (raro, mas poss√≠vel erro de entrada)"
    
    # RBC (Hem√°cias)
    rbc:
      - from: "1e6/ŒºL"
        to: "1e12/L"
        factor: 1.0
        description: "√ó10‚Å∂/ŒºL equivalente a √ó10¬π¬≤/L"
      
      - from: "/ŒºL"
        to: "1e12/L"
        factor: 0.000001
        description: "c√©lulas/ŒºL ‚Üí √ó10¬π¬≤/L"
    
    # Reticul√≥citos
    reticulocytes:
      - from: "%"
        to: "1e9/L"
        formula: "(retic_pct / 100) * rbc * 1000"
        description: "Reticul√≥citos % ‚Üí absolutos (requer RBC)"
        requires: ["rbc"]
      
      - from: "/ŒºL"
        to: "1e9/L"
        factor: 0.001
        description: "Reticul√≥citos /ŒºL ‚Üí √ó10‚Åπ/L"

# =============================================================================
# VALIDA√á√ÉO P√ìS-NORMALIZA√á√ÉO
# =============================================================================
post_normalization_checks:
  - field: "wbc"
    expected_range: [0.1, 200]
    unit: "1e9/L"
    error_message: "WBC fora da faixa esperada ap√≥s normaliza√ß√£o ({value} √ó10‚Åπ/L)"
    action: "flag_for_review"
    severity: "high"
  
  - field: "plt"
    expected_range: [1, 2000]
    unit: "1e9/L"
    error_message: "PLT fora da faixa esperada ap√≥s normaliza√ß√£o ({value} √ó10‚Åπ/L)"
    action: "flag_for_review"
    severity: "high"
  
  - field: "hb"
    expected_range: [1, 25]
    unit: "g/dL"
    error_message: "Hb fora da faixa esperada ap√≥s normaliza√ß√£o ({value} g/dL)"
    action: "flag_for_review"
    severity: "high"
  
  - field: "anc"
    expected_range: [0, 50]
    unit: "1e9/L"
    error_message: "ANC fora da faixa esperada ap√≥s normaliza√ß√£o ({value} √ó10‚Åπ/L)"
    action: "flag_for_review"
    severity: "moderate"
  
  - field: "rbc"
    expected_range: [0.5, 10]
    unit: "1e12/L"
    error_message: "RBC fora da faixa esperada ap√≥s normaliza√ß√£o ({value} √ó10¬π¬≤/L)"
    action: "flag_for_review"
    severity: "moderate"
  
  - field: "mcv"
    expected_range: [50, 150]
    unit: "fL"
    error_message: "MCV fora da faixa fisiol√≥gica ({value} fL)"
    action: "flag_for_review"
    severity: "moderate"
  
  - field: "mchc"
    expected_range: [25, 38]
    unit: "g/dL"
    error_message: "MCHC fora da faixa fisiol√≥gica ({value} g/dL) - suspeita erro pr√©-anal√≠tico"
    action: "trigger_review_sample"
    severity: "critical"

# =============================================================================
# AUDITORIA (WORM - Write Once Read Many)
# =============================================================================
audit:
  enabled: true
  worm: true                         # Immutable logs (write-once)
  storage: "s3://hemodoctor-audit-logs/normalization/"
  retention_days: 90
  encryption: "AES-256-GCM"
  
  log_format: |
    {
      "case_id": "{case_id}",
      "timestamp_utc": "{timestamp_utc}",
      "site_id": "{site_id}",
      "conversions": [
        {
          "field": "{field_name}",
          "original_value": {original_value},
          "original_unit": "{original_unit}",
          "normalized_value": {normalized_value},
          "normalized_unit": "{normalized_unit}",
          "conversion_rule": "{rule_id}",
          "method": "site_specific|auto_detection|known_units",
          "confidence": {confidence_score}
        }
      ],
      "flags": [
        {
          "field": "{field_name}",
          "severity": "critical|high|moderate|low",
          "message": "{flag_message}"
        }
      ],
      "schema_ver": "{schema_ver}",
      "config_ver": "{config_ver}",
      "normalization_ver": "normalization_heuristics_v1.0.0"
    }
  
  log_triggers:
    - "Sempre que convers√£o autom√°tica √© aplicada"
    - "Sempre que flag p√≥s-valida√ß√£o √© disparada"
    - "Sempre que site profile √© atualizado"
  
  compliance:
    - "LGPD Art. 37 (rastreabilidade de decis√µes automatizadas)"
    - "IEC 62304 ¬ß5.1.1 (rastreabilidade de transforma√ß√µes de dados)"
    - "ISO 14971:2019 (rastreabilidade de riscos de convers√£o incorreta)"

# =============================================================================
# TRATAMENTO DE ERROS E FALLBACK
# =============================================================================
error_handling:
  strategy: "fail_safe"              # Nunca recusar caso; sempre processar
  
  scenarios:
    - scenario: "Unidade n√£o reconhecida"
      action: "Assumir unidade can√¥nica de 00_config_hybrid.yaml"
      flag: "‚ö†Ô∏è Unidade desconhecida; assumida {default_unit}"
      severity: "moderate"
      log: true
    
    - scenario: "Convers√£o resulta em valor fora da faixa fisiol√≥gica"
      action: "Aplicar convers√£o mas flagged for review"
      flag: "üî¥ Valor p√≥s-normaliza√ß√£o fora da faixa ({value} {unit})"
      severity: "high"
      log: true
      trigger_review_sample: true
    
    - scenario: "Batch size <50 (auto-detection indispon√≠vel)"
      action: "Usar fallback_single_case heuristic"
      flag: "‚ÑπÔ∏è Batch pequeno; heur√≠stica simples aplicada"
      severity: "low"
      log: true
    
    - scenario: "Site profile confian√ßa <0.80"
      action: "Usar auto-detection em vez de site profile"
      flag: "‚ÑπÔ∏è Site profile incerto; auto-detection ativada"
      severity: "low"
      log: true

# =============================================================================
# EXAMPLES (Casos Reais)
# =============================================================================
examples:
  - description: "WBC em /ŒºL (laborat√≥rio US comum)"
    input:
      wbc: 8500
      unit: "/ŒºL"
    auto_detection_p50: 7200
    conversion:
      method: "auto_detection"
      rule: "p50(wbc) > 1000 ‚Üí divide_by_1000"
      output_wbc: 8.5
      output_unit: "1e9/L"
    log: "WBC em /ŒºL convertido para √ó10‚Åπ/L (p50=7200.0)"
  
  - description: "PLT j√° em √ó10‚Åπ/L (laborat√≥rio BR moderno)"
    input:
      plt: 280
      unit: "1e9/L"
    auto_detection_p50: 250
    conversion:
      method: "no_conversion_needed"
      output_plt: 280
      output_unit: "1e9/L"
    log: "PLT j√° em √ó10‚Åπ/L; sem convers√£o necess√°ria"
  
  - description: "Hb em g/L (sistema SI europeu)"
    input:
      hb: 125
      unit: "g/L"
    conversion:
      method: "known_units"
      rule: "g/L ‚Üí g/dL (factor 0.1)"
      output_hb: 12.5
      output_unit: "g/dL"
    log: "Hb convertida de g/L para g/dL (125 g/L ‚Üí 12.5 g/dL)"
  
  - description: "WBC suspeito (valor imposs√≠vel detectado)"
    input:
      wbc: 250000
      unit: "/ŒºL"
    auto_detection_p50: null  # Caso √∫nico
    conversion:
      method: "fallback_single_case"
      rule: "value > 200 ‚Üí divide_by_1000"
      output_wbc: 250
      output_unit: "1e9/L"
    flag:
      severity: "high"
      message: "WBC fora da faixa esperada ap√≥s normaliza√ß√£o (250 √ó10‚Åπ/L)"
    log: "WBC em /ŒºL convertido para √ó10‚Åπ/L; FLAGGED (valor extremo)"

# =============================================================================
# INTEGRA√á√ÉO COM OUTROS M√ìDULOS
# =============================================================================
integration:
  schema: "01_schema_hybrid.yaml"
  config: "00_config_hybrid.yaml"
  
  pre_analytical_gates: "00_config_hybrid.yaml::pre_analytical_gates"
  post_normalization_triggers:
    - "Se MCHC >37 ou <25 ap√≥s normaliza√ß√£o: disparar E-PRE-MCHC-IMPLAUS"
    - "Se valor fora da faixa ap√≥s normaliza√ß√£o: disparar S-PRE-ANALITICO"
  
  evidence_integration: "02_evidence_hybrid.yaml"
  evidences_triggered:
    - "E-PRE-MCHC-IMPLAUS (se MCHC imposs√≠vel)"
    - "E-PRE-HB-HT-INCONSIST (se inconsist√™ncia Hb/Ht/MCHC)"

# =============================================================================
# METADADOS
# =============================================================================
metadata:
  version: "1.0.0"
  author: "Dr. Abel Costa (IDOR-SP) + AI Medical Device Specialist"
  date: "2025-10-19"
  
  fields_covered: 13
  conversion_rules: 28
  auto_detection_rules: 7
  known_units_mappings: 21
  
  compliance_standards:
    - "LGPD (Lei Geral de Prote√ß√£o de Dados)"
    - "IEC 62304 (Software Lifecycle)"
    - "ISO 14971:2019 (Risk Management)"
    - "ANVISA RDC 751/2022 (Software M√©dico)"

notes: |
  - Normaliza√ß√£o √© Camada A (Ingestion & Normalization) da arquitetura Dev Team
  - Heur√≠stica defensiva: NUNCA recusar caso; sempre processar com flag se necess√°rio
  - p50 (mediana) mais robusto que m√©dia para detectar unidade em batch
  - Site-specific learning reduz falsos positivos ap√≥s bootstrap (100 casos)
  - MCHC >37 g/dL √© imposs√≠vel fisiologicamente ‚Üí sempre dispara review_sample
  - Auditoria WORM garante rastreabilidade para ANVISA/FDA

# =============================================================================
# FIM DO ARQUIVO
# =============================================================================

