# 11_case_state_hybrid.yaml
# State Machine e Reconciliação Incremental - ALWAYS-OUTPUT DESIGN
# Integração SADMH V2.3 Always-Output Design
# Versão: v2.3.0
# Data: 2025-10-19
# Gerenciamento de casos ao longo do tempo com reconciliação automática

version: case_state_hybrid_v2.3.0
module: case_state_manager

description: |
  Módulo de gerenciamento de estado de casos clínicos.
  
  **Funcionalidades:**
  - State machine com 4 estados (OPEN, WAITING_RESULTS, ESCALATED, CLOSED)
  - Reconciliação incremental quando novos exames chegam
  - Histórico de decisões (route_id por timestamp)
  - Integração com WORM log (módulo 08) para auditoria
  - Rastreamento de next_steps solicitados vs recebidos
  
  **Filosofia Always-Output:**
  - Cada evento (NEW_INPUT, RESULTS_ARRIVED) recalcula síndromes
  - Sistema sempre atualiza card (nunca "trava" em estado antigo)
  - Histórico preservado para auditoria

# =============================================================================
# SEÇÃO 1: STATE MACHINE - ESTADOS E TRANSIÇÕES
# =============================================================================
state_machine:
  
  states:
    - name: OPEN
      description: "Caso ativo, aguardando análise ou novos dados"
      color: "#00BFFF"
      allowed_transitions: [WAITING_RESULTS, ESCALATED, CLOSED]
      default_actions:
        - "compute_syndromes"
        - "update_route_id"
        - "render_card"
        - "append_wormlog"
    
    - name: WAITING_RESULTS
      description: "Próximos passos solicitados, aguardando resultados"
      color: "#FFA500"
      allowed_transitions: [OPEN, ESCALATED, CLOSED]
      default_actions:
        - "track_pending_orders"
        - "monitor_timeout"
    
    - name: ESCALATED
      description: "Síndrome crítica detectada, fluxo urgente ativo"
      color: "#FF0000"
      allowed_transitions: [OPEN, WAITING_RESULTS, CLOSED]
      default_actions:
        - "notify_urgent"
        - "lock_route_until_ack"
        - "escalation_protocol"
    
    - name: CLOSED
      description: "Caso encerrado (resolvido, transferido ou timeout)"
      color: "#808080"
      allowed_transitions: []  # Estado final
      default_actions:
        - "seal_case_summary"
        - "append_wormlog_final"
  
  initial_state: OPEN
  
  transitions:
    # -------------------------------------------------------------------------
    # DE: OPEN
    # -------------------------------------------------------------------------
    
    - event: NEW_INPUT
      from: [OPEN, WAITING_RESULTS]
      to: OPEN
      description: "Novos dados chegaram (CBC inicial ou complementares adicionais)"
      conditions: []
      actions:
        - "merge_new_data"
        - "recompute_syndromes"
        - "update_route_id"
        - "render_card"
        - "append_wormlog"
      validation:
        - "new_data must contain at least 1 valid field"
        - "case_id must match existing case"
    
    - event: SUGGESTED_ORDERS_EMITTED
      from: [OPEN]
      to: WAITING_RESULTS
      description: "Next_steps_engine gerou recomendações, aguardando resultados"
      conditions:
        - "next_steps_list is not empty"
      actions:
        - "persist_pending_orders"
        - "set_timeout (default: 30 days)"
        - "update_state_timestamp"
      validation:
        - "at least 1 next_step present"
    
    - event: CRITICAL_FOUND
      from: [OPEN, WAITING_RESULTS]
      to: ESCALATED
      description: "Síndrome crítica detectada"
      conditions:
        - "any critical syndrome true"
      actions:
        - "notify_urgent (SMS/email/pager)"
        - "lock_route_until_ack"
        - "escalation_protocol (enviar para plantonista)"
        - "render_critical_card"
        - "append_wormlog"
      validation:
        - "at least 1 syndrome in [S-NEUTROPENIA-GRAVE, S-BLASTIC-SYNDROME, S-TMA, S-PLT-CRITICA, S-ANEMIA-GRAVE, S-NEUTROFILIA-LEFTSHIFT-CRIT, S-THROMBOCITOSE-CRIT, S-CIVD, S-APL-SUSPEITA]"
    
    - event: CLOSE_CASE
      from: [OPEN]
      to: CLOSED
      description: "Caso resolvido ou encerrado manualmente"
      conditions: []
      actions:
        - "seal_case_summary"
        - "append_wormlog_final"
        - "archive_case_data"
      validation: []
    
    # -------------------------------------------------------------------------
    # DE: WAITING_RESULTS
    # -------------------------------------------------------------------------
    
    - event: RESULTS_ARRIVED
      from: [WAITING_RESULTS]
      to: OPEN
      description: "Resultados dos exames solicitados chegaram"
      conditions:
        - "at least 1 pending_order matched"
      actions:
        - "merge_results"
        - "mark_order_as_received"
        - "recompute_syndromes"
        - "update_route_id"
        - "render_card (updated)"
        - "append_wormlog"
        - "check_if_still_waiting (outros exames pendentes)"
      validation:
        - "received_results must map to pending_orders"
    
    - event: TIMEOUT_WAITING
      from: [WAITING_RESULTS]
      to: CLOSED
      description: "Timeout atingido sem resultados (default: 30 dias)"
      conditions:
        - "current_timestamp > (last_state_change + timeout_duration)"
      actions:
        - "seal_case_summary (incomplete)"
        - "append_wormlog_final (timeout reason)"
        - "notify_timeout"
      validation: []
    
    - event: CRITICAL_FOUND
      from: [WAITING_RESULTS]
      to: ESCALATED
      description: "Resultado crítico chegou enquanto aguardava outros"
      conditions:
        - "any critical syndrome true"
      actions:
        - "notify_urgent"
        - "lock_route_until_ack"
        - "escalation_protocol"
        - "render_critical_card"
        - "append_wormlog"
      validation: []
    
    # -------------------------------------------------------------------------
    # DE: ESCALATED
    # -------------------------------------------------------------------------
    
    - event: ACKNOWLEDGED
      from: [ESCALATED]
      to: OPEN
      description: "Clínico reconheceu alerta crítico"
      conditions:
        - "acknowledgment_received == true"
      actions:
        - "unlock_route"
        - "log_acknowledgment"
        - "update_state_timestamp"
      validation:
        - "acknowledgment must include user_id + timestamp"
    
    - event: RESULTS_ARRIVED
      from: [ESCALATED]
      to: OPEN
      description: "Novos resultados chegaram em caso escalado"
      conditions: []
      actions:
        - "merge_results"
        - "recompute_syndromes"
        - "update_route_id"
        - "render_card"
        - "append_wormlog"
        - "check_if_critical_persists"
      validation: []
    
    - event: CLOSE_CASE
      from: [ESCALATED]
      to: CLOSED
      description: "Caso crítico resolvido ou transferido"
      conditions: []
      actions:
        - "seal_case_summary"
        - "append_wormlog_final"
        - "notify_closure"
      validation: []

# =============================================================================
# SEÇÃO 2: CASE PAYLOAD (ESTRUTURA DE DADOS)
# =============================================================================
case_payload:
  description: "Estrutura de dados completa de um caso ao longo do tempo"
  
  identifiers:
    case_id:
      type: "UUID v4"
      description: "Identificador único do caso"
      immutable: true
    
    case_id_hash:
      type: "SHA256"
      description: "Hash de (site_id | collection_datetime | age_days | sex | salt_site)"
      immutable: true
      purpose: "Pseudonimização para LGPD"
    
    site_id:
      type: "string"
      description: "Laboratório de origem (LAB-01, LAB-02, etc.)"
      immutable: false
    
    patient_pseudonym:
      type: "string"
      description: "Pseudônimo do paciente (irreversível)"
      immutable: true
  
  canonical_inputs:
    description: "Snapshot atual dos analitos (sempre a versão mais recente)"
    structure:
      cbc_data:
        type: "JSONB"
        schema: "01_schema_hybrid.yaml"
        fields: [hb, ht, rbc, wbc, anc, plt, mpv, mcv, mch, mchc, rdw, ...]
      
      morphology_data:
        type: "JSONB"
        schema: "01_schema_hybrid.yaml"
        fields: [esquistocitos, esferocitos, dacriocitos, blasts, bastoes, ...]
      
      complementary_data:
        type: "JSONB"
        schema: "01_schema_hybrid.yaml"
        fields: [ferritin, tsat, crp, b12, folate, ldh, haptoglobin, ...]
      
      molecular_data:
        type: "JSONB"
        schema: "01_schema_hybrid.yaml"
        fields: [bcr_abl_pos, jak2_pos, calr_pos, coombs_pos, ...]
  
  pending_orders:
    description: "Next_steps solicitados mas ainda não recebidos"
    structure:
      - test_id: "string"
        test_name: "string (ex: Ferritina)"
        level: "enum [critical, priority, routine]"
        rationale: "string"
        requested_ts: "timestamp UTC"
        expected_turnaround: "duration (ex: 24h, 3days, 7days)"
        expires_ts: "timestamp UTC (requested_ts + expected_turnaround + 7days)"
        status: "enum [pending, received, expired, cancelled]"
        result: "JSONB (quando received)"
  
  current_route:
    description: "Última decisão do sistema (route_id atual)"
    structure:
      route_id:
        type: "SHA256"
        description: "Hash de (fired_evidences_sorted | accepted_syndromes_sorted | output_class | confidence_bucket)"
        purpose: "Rota única determinística (módulo 06)"
      
      output_class:
        type: "enum"
        values: [critical, priority, review_sample, borderline, routine, c0_guidance]
      
      top_syndromes:
        type: "array of syndrome_id"
        max_length: 3
        description: "Até 3 síndromes de maior prioridade"
      
      confidence_bucket:
        type: "enum"
        values: [C0, C1, C2]
      
      missing_keys:
        type: "array of field_name"
        description: "Campos-chave ausentes"
      
      next_steps:
        type: "array of next_step_item"
        max_length: 8
        description: "Próximos passos recomendados (módulo 09)"
      
      card_rendered:
        type: "JSONB"
        formats: [markdown, html, json]
        description: "Card final renderizado (módulo 12)"
  
  history:
    description: "Histórico de decisões (todas as route_id)"
    structure:
      - route_id: "SHA256"
        timestamp: "UTC"
        event: "enum [NEW_INPUT, RESULTS_ARRIVED, CRITICAL_FOUND]"
        syndromes_at_time: "array"
        confidence_at_time: "enum [C0, C1, C2]"
        data_snapshot: "JSONB (apenas campos que mudaram)"
  
  state_metadata:
    current_state: "enum [OPEN, WAITING_RESULTS, ESCALATED, CLOSED]"
    last_state_change: "timestamp UTC"
    state_history:
      - from_state: "enum"
        to_state: "enum"
        event: "string"
        timestamp: "UTC"
        user_id: "string (se manual)"
  
  created_at: "timestamp UTC"
  updated_at: "timestamp UTC"
  closed_at: "timestamp UTC (se estado CLOSED)"
  
  engine_versions:
    config_hash: "SHA256 (00_config_hybrid.yaml)"
    schema_hash: "SHA256 (01_schema_hybrid.yaml)"
    evidence_hash: "SHA256 (02_evidence_hybrid.yaml)"
    syndromes_hash: "SHA256 (03_syndromes_hybrid.yaml)"
    missingness_hash: "SHA256 (05_missingness_hybrid_v2.3.yaml)"
    engine_version: "semver (ex: 1.0.0)"

# =============================================================================
# SEÇÃO 3: RECONCILIAÇÃO INCREMENTAL
# =============================================================================
reconciliation:
  description: |
    Quando novos dados chegam (evento RESULTS_ARRIVED ou NEW_INPUT),
    sistema mescla com dados antigos e recalcula síndromes.
  
  merge_strategy:
    rule: "last_write_wins"
    conflict_resolution: "newer_timestamp_prevails"
    null_handling: "preserve_existing_if_new_is_null"
    
    example: |
      # Estado anterior do caso
      case_old = {
        "hb": 9.5,
        "mcv": 72,
        "rdw": 16,
        "ferritin": null,
        "tsat": null,
        "timestamp": "2025-10-19T10:00:00Z"
      }
      
      # Novos resultados chegam
      new_data = {
        "ferritin": 8,
        "tsat": 12,
        "crp": 5,
        "timestamp": "2025-10-19T14:00:00Z"
      }
      
      # Merge
      case_merged = {
        "hb": 9.5,           # mantido (não veio novo)
        "mcv": 72,           # mantido
        "rdw": 16,           # mantido
        "ferritin": 8,       # NOVO (null → 8)
        "tsat": 12,          # NOVO (null → 12)
        "crp": 5,            # NOVO (ausente → 5)
        "timestamp": "2025-10-19T14:00:00Z"
      }
      
      # Recalcular
      syndromes_old = [S-IDA (C1)]  # Sem ferritina
      syndromes_new = [S-IDA (C2)]  # Com ferritina <30, confirmado
      
      # Atualizar card
      card_old = "PRIORIDADE: S-IDA (C1) + next_steps [Ferritina, TSat]"
      card_new = "PRIORIDADE: S-IDA (C2) + next_steps [Repetir CBC 4-8 sem]"
  
  recalculation_pipeline:
    1: "Merge new data with canonical_inputs (last_write_wins)"
    2: "Update timestamp"
    3: "Run normalization (00_config_hybrid.yaml)"
    4: "Recompute evidences (02_evidence_hybrid.yaml)"
    5: "Recompute syndromes (03_syndromes_hybrid.yaml)"
    6: "Recompute missingness (05_missingness_hybrid_v2.3.yaml)"
    7: "Recompute route_id (06_route_policy_hybrid.yaml)"
    8: "Recompute next_steps (09_next_steps_engine_hybrid.yaml)"
    9: "Render card (12_output_policies_hybrid.yaml)"
    10: "Append WORM log (08_wormlog_hybrid.yaml)"
  
  change_detection:
    description: "Detectar se houve mudança significativa na decisão"
    fields_to_compare:
      - "output_class (critical vs priority)"
      - "top_syndromes (lista de síndromes)"
      - "confidence_bucket (C0 vs C1 vs C2)"
    
    actions_if_changed:
      - "Notify clínico (se upgrade C1→C2 ou downgrade C2→C1)"
      - "Log change reason"
      - "Update card"
    
    actions_if_unchanged:
      - "Log 'no change in decision'"
      - "Update timestamp only"

# =============================================================================
# SEÇÃO 4: PENDING ORDERS TRACKING
# =============================================================================
pending_orders_tracking:
  description: "Rastrear quais exames foram solicitados vs recebidos"
  
  workflow:
    1: "Next_steps_engine gera lista de recomendações (0-8 exames)"
    2: "Case state manager persiste como pending_orders"
    3: "Estado muda para WAITING_RESULTS"
    4: "Quando exame chega: match por test_name ou LOINC code"
    5: "Marca order como received + timestamp"
    6: "Recalcula síndromes com novo dado"
    7: "Remove order de pending se todos recebidos → volta para OPEN"
  
  matching_logic:
    description: "Como identificar qual pending_order corresponde ao resultado chegado"
    strategies:
      - strategy: "exact_test_name"
        description: "Match direto (ex: 'Ferritina' == 'Ferritina')"
        priority: 1
      
      - strategy: "loinc_code"
        description: "Match por LOINC (ex: 2276-4 = Ferritina)"
        priority: 2
      
      - strategy: "fuzzy_match"
        description: "Match aproximado (ex: 'Ferritin' → 'Ferritina')"
        priority: 3
      
      - strategy: "manual_mapping"
        description: "Mapper.csv do site (ex: 'FER' → 'Ferritina')"
        priority: 4
  
  timeout_policy:
    description: "O que fazer se exame não chegar no prazo esperado"
    default_timeout: "expected_turnaround + 7 days"
    
    actions_on_timeout:
      - "Mark order as expired"
      - "Notify clínico (exame não chegou)"
      - "Re-evaluate if case can proceed without it"
      - "If all expired + no new data for 30 days → CLOSE case"
  
  example:
    case_id: "abc123"
    state: "WAITING_RESULTS"
    pending_orders:
      - test_id: "order-001"
        test_name: "Ferritina"
        level: "priority"
        requested_ts: "2025-10-19T10:00:00Z"
        expected_turnaround: "24h"
        expires_ts: "2025-10-27T10:00:00Z"  # 24h + 7 days
        status: "pending"
      
      - test_id: "order-002"
        test_name: "TSat"
        level: "priority"
        requested_ts: "2025-10-19T10:00:00Z"
        expected_turnaround: "24h"
        expires_ts: "2025-10-27T10:00:00Z"
        status: "pending"
    
    # Ferritina chega
    new_result:
      test_name: "Ferritina"
      value: 8
      unit: "ng/mL"
      timestamp: "2025-10-19T14:00:00Z"
    
    # Após reconciliação
    pending_orders_updated:
      - test_id: "order-001"
        test_name: "Ferritina"
        status: "received"  # MUDOU
        result: {value: 8, unit: "ng/mL", timestamp: "2025-10-19T14:00:00Z"}
      
      - test_id: "order-002"
        test_name: "TSat"
        status: "pending"  # Ainda aguardando

# =============================================================================
# SEÇÃO 5: ESCALATION PROTOCOL (CRÍTICOS)
# =============================================================================
escalation_protocol:
  description: "Protocolo de escalonamento para síndromes críticas"
  
  trigger_syndromes:
    - S-NEUTROPENIA-GRAVE (ANC <0.5)
    - S-BLASTIC-SYNDROME (blastos presentes)
    - S-TMA (esquistócitos + PLT <30)
    - S-PLT-CRITICA (PLT <20)
    - S-ANEMIA-GRAVE (Hb <6.5 M ou <6.0 F)
    - S-NEUTROFILIA-LEFTSHIFT-CRIT (WBC >11 + left shift + CRP >10)
    - S-THROMBOCITOSE-CRIT (PLT ≥1000)
    - S-CIVD (≥2 marcadores alterados)
    - S-APL-SUSPEITA (promielócitos + coagulopatia)
  
  notification_channels:
    - channel: "email"
      priority: "high"
      template: "critical_alert_email.html"
      recipients: ["plantonista@hospital.com", "hematologista@hospital.com"]
    
    - channel: "sms"
      priority: "urgent"
      template: "critical_alert_sms.txt"
      recipients: ["phone_plantonista", "phone_hematologista"]
    
    - channel: "pager"
      priority: "stat"
      only_if: "(anc < 0.2) OR (plt < 10) OR (S-APL-SUSPEITA)"
    
    - channel: "ui_banner"
      priority: "critical"
      display_location: "top_of_screen"
      color: "#FF0000"
      flash: true
  
  acknowledgment_required:
    description: "Clínico DEVE reconhecer alerta crítico"
    timeout_if_no_ack: "15 minutes"
    escalate_to: "supervisor_if_no_ack"
    
    ack_payload:
      user_id: "required"
      timestamp: "required"
      comment: "optional"
      action_taken: "enum [reviewed, ordered_tests, consulted_specialist, transferred_patient]"
  
  lock_route:
    description: "Impede atualizações automáticas até ack"
    purpose: "Garantir que clínico viu alerta crítico antes de sistema recalcular"
    unlock_conditions:
      - "acknowledgment_received == true"
      - "timeout_reached (15 min) AND escalated_to_supervisor"

# =============================================================================
# SEÇÃO 6: METADATA E AUDITORIA
# =============================================================================
metadata:
  version: "v2.3.0"
  module: "case_state_manager"
  dependencies:
    - "08_wormlog_hybrid.yaml (auditoria)"
    - "09_next_steps_engine_hybrid.yaml (pending_orders)"
    - "12_output_policies_hybrid.yaml (card render)"
  
  states_count: 4
  events_count: 8
  transitions_count: 11
  
  always_output_guarantee:
    description: "Cada transição (NEW_INPUT, RESULTS_ARRIVED) sempre recalcula e atualiza card"
    never_blocks: "Sistema nunca 'trava' em estado antigo"
    history_preserved: "Todos os route_id anteriores preservados em history[]"

validation:
  test_cases:
    - name: "CBC inicial → Ferritina chega → Recalcula IDA C1→C2"
      initial_state: "OPEN"
      events:
        - event: "NEW_INPUT (CBC: hb=9.5, mcv=72, rdw=16)"
          expected_state: "OPEN"
          expected_syndromes: ["S-IDA (C1)"]
          expected_next_steps: ["Ferritina", "TSat"]
        
        - event: "SUGGESTED_ORDERS_EMITTED"
          expected_state: "WAITING_RESULTS"
          expected_pending: ["Ferritina", "TSat"]
        
        - event: "RESULTS_ARRIVED (Ferritina=8)"
          expected_state: "OPEN"
          expected_syndromes: ["S-IDA (C2)"]
          expected_next_steps: ["CBC repeat 4-8 sem"]
          expected_pending: ["TSat (still pending)"]
    
    - name: "CBC normal → CLOSE imediato"
      initial_state: "OPEN"
      events:
        - event: "NEW_INPUT (CBC: hb=14, plt=200, wbc=7)"
          expected_state: "OPEN"
          expected_syndromes: []
          expected_card: "routine_normal"
        
        - event: "CLOSE_CASE (resolvido)"
          expected_state: "CLOSED"
    
    - name: "Neutropenia grave → ESCALATED → ACK → OPEN"
      initial_state: "OPEN"
      events:
        - event: "NEW_INPUT (anc=0.3)"
          expected_state: "ESCALATED"
          expected_syndromes: ["S-NEUTROPENIA-GRAVE"]
          expected_notifications: ["email", "sms"]
        
        - event: "ACKNOWLEDGED (user_id=dr_abel)"
          expected_state: "OPEN"
          expected_route_unlocked: true

notes: |
  - State machine garante gestão consistente de casos ao longo do tempo
  - Reconciliação incremental permite atualização com novos dados
  - Pending_orders tracking rastreia quais exames foram solicitados
  - Escalation protocol garante resposta rápida em casos críticos
  - Histórico completo preservado para auditoria (WORM log módulo 08)
  - Sempre recalcula síndromes ao receber novos dados (always-output)
  - Lock_route impede mudanças até acknowledgment em críticos

# =============================================================================
# FIM DO ARQUIVO
# =============================================================================

