openapi: 3.1.0

info:
  title: HemoDoctor API Gateway
  version: 1.0.0
  description: |
    **External-facing API Gateway** for HemoDoctor SaMD platform.

    **IEC 62304 Classification:** Class B (critical routing, no diagnostic logic)

    **Responsibilities:**
    - Authentication/Authorization (OAuth2/OIDC)
    - Rate limiting (100 requests/min per client)
    - Request routing to backend microservices
    - TLS termination
    - Class C isolation enforcement

    **Security:** All endpoints require OAuth2 authentication with appropriate scopes.

    **Traceability:** SDD-001 §3.1 | REQ-HD-005 (SRS-001)

  contact:
    name: HemoDoctor API Support
    email: api-support@hemodoctor.com
    url: https://docs.hemodoctor.com

  license:
    name: Proprietary
    url: https://hemodoctor.com/license

servers:
  - url: https://api-dev.hemodoctor.com/api/v1
    description: Development environment
  - url: https://api-staging.hemodoctor.com/api/v1
    description: Staging environment
  - url: https://api.hemodoctor.com/api/v1
    description: Production environment

security:
  - OAuth2:
      - read:results
      - write:orders
      - admin:system
  - BearerAuth: []

tags:
  - name: CBC Analysis
    description: Submit and retrieve CBC analysis results
  - name: Audit
    description: Audit trail and traceability
  - name: Alerts
    description: Clinical alert management
  - name: Health
    description: System health and monitoring

paths:
  /cbc/analyze:
    post:
      summary: Submit CBC for analysis
      description: |
        Submit Complete Blood Count (CBC) data for automated analysis.

        **Workflow:**
        1. API Gateway validates JWT token and rate limits
        2. Request forwarded to Ingestion Service (Class B)
        3. Data flows through Validation → Rules Engine → HemoAI → Alert Orchestrator (Class C)
        4. Results returned with trace_id for audit trail

        **Critical:** This endpoint triggers Class C diagnostic logic.

        **Traceability:** REQ-HD-001, REQ-HD-002 (SRS-001)

      operationId: submitCBCAnalysis
      tags:
        - CBC Analysis

      security:
        - OAuth2:
            - write:orders

      parameters:
        - name: Idempotency-Key
          in: header
          description: Client-generated UUID for idempotent requests (optional)
          required: false
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"

      requestBody:
        description: CBC data with patient demographics and hemogram values
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CBCSubmission'
            examples:
              normal_adult_male:
                summary: Normal adult male CBC
                value:
                  external_order_id: "ORD-2025-001234"
                  patient:
                    age: 45
                    sex: "M"
                    pregnancy: false
                  hemogram:
                    hemoglobin:
                      value: 14.5
                      unit: "g/dL"
                    hematocrit:
                      value: 43.5
                      unit: "%"
                    mcv:
                      value: 88
                      unit: "fL"
                    mch:
                      value: 29.5
                      unit: "pg"
                    mchc:
                      value: 33.5
                      unit: "g/dL"
                    rdw:
                      value: 13.2
                      unit: "%"
                    wbc:
                      value: 7.5
                      unit: "10*3/uL"
                    platelets:
                      value: 250
                      unit: "10*3/uL"
                    neutrophils:
                      value: 60
                      unit: "%"
                    lymphocytes:
                      value: 30
                      unit: "%"
                    monocytes:
                      value: 6
                      unit: "%"
                    eosinophils:
                      value: 3
                      unit: "%"
                    basophils:
                      value: 1
                      unit: "%"
                    reticulocytes:
                      value: 1.2
                      unit: "%"
              severe_anemia:
                summary: Severe microcytic anemia (CRITICAL alert)
                value:
                  external_order_id: "ORD-2025-001235"
                  patient:
                    age: 35
                    sex: "F"
                    pregnancy: false
                  hemogram:
                    hemoglobin:
                      value: 6.2
                      unit: "g/dL"
                    hematocrit:
                      value: 20.5
                      unit: "%"
                    mcv:
                      value: 65
                      unit: "fL"
                    rdw:
                      value: 18.5
                      unit: "%"
                  complementary:
                    ferritin:
                      value: 8
                      unit: "ng/mL"

      responses:
        '200':
          description: CBC analysis completed successfully
          headers:
            X-RateLimit-Limit:
              schema:
                type: integer
              description: Request limit per minute
            X-RateLimit-Remaining:
              schema:
                type: integer
              description: Remaining requests in current window
            X-Trace-ID:
              schema:
                type: string
                format: uuid
              description: Distributed trace ID for debugging
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalysisResponse'
              examples:
                normal_result:
                  summary: Normal CBC with no alerts
                  value:
                    case_id: "6fa459ea-ee8a-3ca4-894e-db77e160355e"
                    status: "COMPLETED"
                    timestamp: "2025-10-08T15:32:10Z"
                    analysis_result:
                      risk_score: 0.12
                      confidence: 0.95
                      top_diagnoses:
                        - diagnosis: "Normal hemogram"
                          probability: 0.88
                          clinical_rationale: "All parameters within normal reference ranges for adult male"
                      recommendations:
                        - "No additional tests required"
                        - "Routine follow-up as per clinical protocol"
                      model_version: "hemoai-v1.2.3"
                      rules_version: "rules-v2.3.1"
                    alerts: []
                    trace_id: "7c9e6679-7425-40de-944b-e07fc1f90ae7"
                critical_alert:
                  summary: Severe anemia with CRITICAL alert
                  value:
                    case_id: "8ea459ea-ee8a-3ca4-894e-db77e160355f"
                    status: "COMPLETED"
                    timestamp: "2025-10-08T15:35:22Z"
                    analysis_result:
                      risk_score: 0.92
                      confidence: 0.98
                      top_diagnoses:
                        - diagnosis: "Severe iron deficiency anemia"
                          probability: 0.92
                          clinical_rationale: "Hb 6.2 g/dL + MCV 65 fL + ferritin 8 ng/mL indicates severe iron deficiency"
                        - diagnosis: "Thalassemia minor"
                          probability: 0.08
                      recommendations:
                        - "Immediate physician notification"
                        - "Iron panel confirmation"
                        - "Transfusion protocol evaluation"
                        - "GI bleeding investigation"
                      model_version: "hemoai-v1.2.3"
                      rules_version: "rules-v2.3.1"
                    alerts:
                      - alert_id: "ALT-2025-001235"
                        level: "CRITICAL"
                        message: "Severe anemia detected (Hb 6.2 g/dL)"
                        suggested_actions:
                          - "Immediate physician notification"
                          - "Transfusion protocol"
                        triggered_at: "2025-10-08T15:35:22Z"
                    trace_id: "9fa459ea-ee8a-3ca4-894e-db77e160355g"

        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalError'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'

  /results/{case_id}:
    get:
      summary: Retrieve analysis results by case ID
      description: |
        Retrieve complete analysis results for a specific case.

        **Traceability:** REQ-HD-003 (SRS-001)

      operationId: getAnalysisResults
      tags:
        - CBC Analysis

      security:
        - OAuth2:
            - read:results

      parameters:
        - name: case_id
          in: path
          description: Unique case identifier (returned from POST /cbc/analyze)
          required: true
          schema:
            type: string
            format: uuid
            example: "6fa459ea-ee8a-3ca4-894e-db77e160355e"

      responses:
        '200':
          description: Analysis results retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalysisResponse'

        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'

  /audit/{case_id}:
    get:
      summary: Retrieve complete audit trail for a case
      description: |
        Retrieve immutable audit trail showing all processing steps.

        **Traceability:** REQ-HD-004 (SRS-001)

      operationId: getAuditTrail
      tags:
        - Audit

      security:
        - OAuth2:
            - admin:system

      parameters:
        - name: case_id
          in: path
          description: Unique case identifier
          required: true
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          description: Maximum number of audit entries to return
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: cursor
          in: query
          description: Cursor for pagination (from previous response)
          required: false
          schema:
            type: string

      responses:
        '200':
          description: Audit trail retrieved successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - data
                  - pagination
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/AuditLogEntry'
                  pagination:
                    $ref: '#/components/schemas/PaginationInfo'
              examples:
                audit_trail:
                  summary: Complete audit trail for CBC analysis
                  value:
                    data:
                      - log_id: 1001
                        timestamp: "2025-10-08T15:32:10.123Z"
                        event_type: "EVENT_INGEST"
                        service: "ingestion-service"
                        order_id: "ORD-2025-001234"
                        payload_hash: "sha256:a3f8e7d2..."
                        user_id: "system"
                      - log_id: 1002
                        timestamp: "2025-10-08T15:32:10.456Z"
                        event_type: "EVENT_VALIDATE"
                        service: "validation-service"
                        order_id: "ORD-2025-001234"
                        payload_hash: "sha256:b4f9e8d3..."
                        user_id: "system"
                      - log_id: 1003
                        timestamp: "2025-10-08T15:32:10.789Z"
                        event_type: "BOUNDARY_CROSS"
                        service: "validation-service"
                        destination: "rules-engine-classc"
                        order_id: "ORD-2025-001234"
                        firewall_rule: "ALLOW_VALIDATION_TO_RULES"
                        user_id: "system"
                      - log_id: 1004
                        timestamp: "2025-10-08T15:32:11.234Z"
                        event_type: "EVENT_SCORE"
                        service: "hemoai-inference"
                        order_id: "ORD-2025-001234"
                        model_version: "hemoai-v1.2.3"
                        risk_score: 0.12
                        user_id: "system"
                      - log_id: 1005
                        timestamp: "2025-10-08T15:32:11.567Z"
                        event_type: "EVENT_ALERT"
                        service: "alert-orchestrator"
                        order_id: "ORD-2025-001234"
                        alert_level: "LOW"
                        user_id: "system"
                    pagination:
                      cursor: "eyJsb2dfaWQiOjEwMDV9"
                      has_more: false
                      total_count: 5

        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'

  /alerts:
    get:
      summary: List active alerts
      description: |
        Retrieve all active clinical alerts (CRITICAL, HIGH, MEDIUM, LOW).

        **Traceability:** REQ-HD-001 (SRS-001)

      operationId: listAlerts
      tags:
        - Alerts

      security:
        - OAuth2:
            - read:results

      parameters:
        - name: level
          in: query
          description: Filter by alert level
          required: false
          schema:
            type: string
            enum: [CRITICAL, HIGH, MEDIUM, LOW]
        - name: acknowledged
          in: query
          description: Filter by acknowledgment status
          required: false
          schema:
            type: boolean
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: cursor
          in: query
          schema:
            type: string

      responses:
        '200':
          description: Alerts retrieved successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - data
                  - pagination
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Alert'
                  pagination:
                    $ref: '#/components/schemas/PaginationInfo'

        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'

  /alerts/{alert_id}/acknowledge:
    post:
      summary: Acknowledge an alert
      description: |
        Mark an alert as acknowledged by a clinician.

        **Traceability:** REQ-HD-003 (SRS-001)

      operationId: acknowledgeAlert
      tags:
        - Alerts

      security:
        - OAuth2:
            - write:orders

      parameters:
        - name: alert_id
          in: path
          description: Unique alert identifier
          required: true
          schema:
            type: string
            format: uuid

      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - acknowledged_by
              properties:
                acknowledged_by:
                  type: string
                  description: User ID or clinician name
                  example: "Dr. Silva (CRM 12345-SP)"
                notes:
                  type: string
                  maxLength: 500
                  description: Optional acknowledgment notes

      responses:
        '200':
          description: Alert acknowledged successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Alert'

        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'

  /health:
    get:
      summary: Health check endpoint
      description: |
        Basic health check for load balancers and monitoring systems.

        **No authentication required.**

      operationId: healthCheck
      tags:
        - Health

      security: []

      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                required:
                  - status
                  - timestamp
                properties:
                  status:
                    type: string
                    enum: [healthy]
                  timestamp:
                    type: string
                    format: date-time
                  version:
                    type: string
                    example: "1.0.0"
              example:
                status: healthy
                timestamp: "2025-10-08T15:32:10Z"
                version: "1.0.0"

        '503':
          $ref: '#/components/responses/ServiceUnavailable'

components:
  securitySchemes:
    OAuth2:
      type: oauth2
      description: OAuth2 authentication with OIDC
      flows:
        authorizationCode:
          authorizationUrl: https://auth.hemodoctor.com/oauth2/authorize
          tokenUrl: https://auth.hemodoctor.com/oauth2/token
          scopes:
            read:results: Read analysis results
            write:orders: Submit new orders
            admin:system: System administration

    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token for service-to-service authentication

  schemas:
    CBCSubmission:
      type: object
      required:
        - external_order_id
        - patient
        - hemogram
      properties:
        external_order_id:
          type: string
          description: External order ID from LIS/HIS system
          example: "ORD-2025-001234"
        patient:
          $ref: '#/components/schemas/PatientProfile'
        hemogram:
          $ref: '#/components/schemas/Hemogram'
        complementary:
          $ref: '#/components/schemas/ComplementaryTests'

    PatientProfile:
      type: object
      required:
        - age
        - sex
      properties:
        age:
          type: integer
          minimum: 0
          maximum: 120
          description: Patient age in years
        sex:
          type: string
          enum: [M, F, Other]
          description: Biological sex
        pregnancy:
          type: boolean
          description: Pregnancy status (required if sex=F and age 12-55)

    Hemogram:
      type: object
      required:
        - hemoglobin
        - hematocrit
        - mcv
        - rdw
        - wbc
        - platelets
      properties:
        hemoglobin:
          $ref: '#/components/schemas/MeasuredValue'
        hematocrit:
          $ref: '#/components/schemas/MeasuredValue'
        mcv:
          $ref: '#/components/schemas/MeasuredValue'
        mch:
          $ref: '#/components/schemas/MeasuredValue'
        mchc:
          $ref: '#/components/schemas/MeasuredValue'
        rdw:
          $ref: '#/components/schemas/MeasuredValue'
        wbc:
          $ref: '#/components/schemas/MeasuredValue'
        platelets:
          $ref: '#/components/schemas/MeasuredValue'
        neutrophils:
          $ref: '#/components/schemas/MeasuredValue'
        lymphocytes:
          $ref: '#/components/schemas/MeasuredValue'
        monocytes:
          $ref: '#/components/schemas/MeasuredValue'
        eosinophils:
          $ref: '#/components/schemas/MeasuredValue'
        basophils:
          $ref: '#/components/schemas/MeasuredValue'
        reticulocytes:
          $ref: '#/components/schemas/MeasuredValue'

    ComplementaryTests:
      type: object
      description: Optional complementary test results
      properties:
        ferritin:
          $ref: '#/components/schemas/MeasuredValue'
        iron:
          $ref: '#/components/schemas/MeasuredValue'
        transferrin:
          $ref: '#/components/schemas/MeasuredValue'
        vitamin_b12:
          $ref: '#/components/schemas/MeasuredValue'
        folate:
          $ref: '#/components/schemas/MeasuredValue'

    MeasuredValue:
      type: object
      required:
        - value
        - unit
      properties:
        value:
          type: number
          description: Numeric measurement value
        unit:
          type: string
          description: UCUM unit of measure
          example: "g/dL"

    AnalysisResponse:
      type: object
      required:
        - case_id
        - status
        - timestamp
        - trace_id
      properties:
        case_id:
          type: string
          format: uuid
          description: Unique case identifier
        status:
          type: string
          enum: [COMPLETED, PENDING, FAILED]
        timestamp:
          type: string
          format: date-time
        analysis_result:
          $ref: '#/components/schemas/AnalysisResult'
        alerts:
          type: array
          items:
            $ref: '#/components/schemas/Alert'
        trace_id:
          type: string
          format: uuid
          description: Distributed trace ID

    AnalysisResult:
      type: object
      required:
        - risk_score
        - confidence
        - top_diagnoses
        - recommendations
        - model_version
        - rules_version
      properties:
        risk_score:
          type: number
          minimum: 0
          maximum: 1
          description: Overall risk score (0-1 scale)
        confidence:
          type: number
          minimum: 0
          maximum: 1
          description: Model confidence in prediction
        top_diagnoses:
          type: array
          items:
            $ref: '#/components/schemas/Diagnosis'
          minItems: 1
          maxItems: 5
        recommendations:
          type: array
          items:
            type: string
          description: Clinical recommendations
        clinical_rationale:
          type: string
          description: Human-readable explanation
        model_version:
          type: string
          example: "hemoai-v1.2.3"
        rules_version:
          type: string
          example: "rules-v2.3.1"

    Diagnosis:
      type: object
      required:
        - diagnosis
        - probability
        - clinical_rationale
      properties:
        diagnosis:
          type: string
          description: Diagnosis name
        probability:
          type: number
          minimum: 0
          maximum: 1
          description: Probability score
        clinical_rationale:
          type: string
          description: Explanation of diagnosis
        supporting_parameters:
          type: array
          items:
            type: string
          description: CBC parameters supporting this diagnosis

    Alert:
      type: object
      required:
        - alert_id
        - level
        - case_id
        - message
        - triggered_at
      properties:
        alert_id:
          type: string
          format: uuid
        level:
          type: string
          enum: [CRITICAL, HIGH, MEDIUM, LOW]
        case_id:
          type: string
          format: uuid
        message:
          type: string
          maxLength: 500
        suggested_actions:
          type: array
          items:
            type: string
        triggered_at:
          type: string
          format: date-time
        acknowledged:
          type: boolean
          default: false
        acknowledged_by:
          type: string
        acknowledged_at:
          type: string
          format: date-time

    AuditLogEntry:
      type: object
      required:
        - log_id
        - timestamp
        - event_type
        - service
      properties:
        log_id:
          type: integer
          format: int64
        timestamp:
          type: string
          format: date-time
        event_type:
          type: string
          enum:
            - EVENT_INGEST
            - EVENT_VALIDATE
            - EVENT_SCORE
            - EVENT_ALERT
            - EVENT_DECISION
            - EVENT_OVERRIDE
            - BOUNDARY_CROSS
        service:
          type: string
          description: Service that generated the event
        order_id:
          type: string
        case_id:
          type: string
          format: uuid
        user_id:
          type: string
        payload_hash:
          type: string
          description: SHA-256 hash of event payload
        signature:
          type: string
          description: Cryptographic signature for integrity

    PaginationInfo:
      type: object
      required:
        - has_more
      properties:
        cursor:
          type: string
          description: Cursor for next page (null if no more pages)
        has_more:
          type: boolean
        total_count:
          type: integer
          description: Total number of results (optional)

    ProblemDetail:
      type: object
      description: RFC 7807 Problem Details
      required:
        - type
        - title
        - status
      properties:
        type:
          type: string
          format: uri
          description: URI identifying the problem type
        title:
          type: string
          description: Short human-readable summary
        status:
          type: integer
          description: HTTP status code
        detail:
          type: string
          description: Human-readable explanation
        instance:
          type: string
          format: uri
          description: URI identifying the specific occurrence
        trace_id:
          type: string
          format: uuid
        invalid_params:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              reason:
                type: string

  responses:
    BadRequest:
      description: Invalid request data
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
          example:
            type: "https://api.hemodoctor.com/errors/validation-error"
            title: "Invalid CBC data"
            status: 400
            detail: "Hemoglobin value 35.2 g/dL exceeds physiological limit (max 25 g/dL)"
            instance: "/api/v1/cbc/analyze"
            trace_id: "7c9e6679-7425-40de-944b-e07fc1f90ae7"
            invalid_params:
              - name: "hemogram.hemoglobin.value"
                reason: "Value exceeds physiological maximum"

    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
          example:
            type: "https://api.hemodoctor.com/errors/authentication-required"
            title: "Authentication required"
            status: 401
            detail: "Missing or invalid JWT token"

    Forbidden:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
          example:
            type: "https://api.hemodoctor.com/errors/forbidden"
            title: "Insufficient permissions"
            status: 403
            detail: "User lacks 'write:orders' scope"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
          example:
            type: "https://api.hemodoctor.com/errors/not-found"
            title: "Case not found"
            status: 404
            detail: "No analysis found for case_id: 6fa459ea-ee8a-3ca4-894e-db77e160355e"

    RateLimitExceeded:
      description: Rate limit exceeded
      headers:
        X-RateLimit-Limit:
          schema:
            type: integer
        X-RateLimit-Remaining:
          schema:
            type: integer
            enum: [0]
        X-RateLimit-Reset:
          schema:
            type: integer
          description: Unix timestamp when limit resets
        Retry-After:
          schema:
            type: integer
          description: Seconds to wait before retrying
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
          example:
            type: "https://api.hemodoctor.com/errors/rate-limit-exceeded"
            title: "Rate limit exceeded"
            status: 429
            detail: "You have exceeded 100 requests per minute"
            retry_after: 45

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
          example:
            type: "https://api.hemodoctor.com/errors/internal-error"
            title: "Internal server error"
            status: 500
            detail: "An unexpected error occurred"
            trace_id: "7c9e6679-7425-40de-944b-e07fc1f90ae7"

    ServiceUnavailable:
      description: Service temporarily unavailable
      headers:
        Retry-After:
          schema:
            type: integer
          description: Seconds to wait before retrying
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
          example:
            type: "https://api.hemodoctor.com/errors/service-unavailable"
            title: "Service unavailable"
            status: 503
            detail: "Downstream service timeout"
            retry_after: 30
