# TRC-001 v2.2 - NEW TRACEABILITY ENTRIES

**Section to add:** After REQ-HD-032 (existing last requirement)
**Action:** INSERT these 3 new requirement entries + 2 new risk entries

---

## NEW REQUIREMENTS (3 total)

### REQ-HD-033: Red List FN=0 Validation (240 Test Cases)

**Priority:** CRITICAL
**Description:** Guarantee FN=0 for 8 critical syndromes through 240 test cases (30 per syndrome)

**Design:** SDD-001 ¬ß4.3.3 (Solution 2), ¬ß4.4.2 (Red List validation)

**Verification:**
- **TEST-HD-269 to 508** (240 test cases total)
  - TEST-HD-269 to 298: S-NEUTROPENIA-GRAVE (30 cases)
  - TEST-HD-299 to 328: S-BLASTIC-SYNDROME (30 cases)
  - TEST-HD-329 to 358: S-TMA (30 cases)
  - TEST-HD-359 to 388: S-PLT-CRITICA (30 cases)
  - TEST-HD-389 to 418: S-ANEMIA-GRAVE (30 cases)
  - TEST-HD-419 to 448: S-NEUTROFILIA-LEFTSHIFT-CRIT (30 cases)
  - TEST-HD-449 to 478: S-THROMBOCITOSE-CRIT (30 cases)
  - TEST-HD-479 to 508: S-CIVD (30 cases)
- **Implementation:** `tests/clinical/test_red_list_validation.py`
- **Data:** `data/red_list/critical_cases.json` (240 synthetic cases)
- **Result:** 240/240 passing (100% FN=0) - Sprint 4 (22 Oct 2025)

**Risk Controls:**
- RISK-HD-001: False negative critical anemia
- RISK-HD-018: Evidence false negatives
- RISK-HD-050: Multiple critical syndromes co-occurrence ‚≠ê NEW

**IFU:** IFU-001 ¬ß4 (Clinical Validation Statement)

**PMS:** PMS-001 ¬ß5.1 (Critical syndrome monitoring)

**Status:** ‚úÖ IMPLEMENTED (Sprint 4, 22 Oct 2025)

---

### REQ-HD-034: Multiple Critical Syndromes Support (Solution 2)

**Priority:** CRITICAL
**Description:** Detect and report multiple co-occurring critical syndromes (e.g., PLT ‚â•1000 + neutrofilia)

**Design:**
- SDD-001 ¬ß4.3.3 (Solution 2 algorithm - SUPERSEDES v2.1 short-circuit)
- SDD-001_v2.2_PATCH_SOLUTION2.md ‚≠ê

**Algorithm:**
```python
# Solution 2: Allow multiple critical, THEN short-circuit
if syndrome.criticality == "critical":
    remaining_critical = [s for s in syndromes
                         if s.criticality == "critical"
                         and s.id not in detected]
    if not remaining_critical:
        break  # Only after all critical evaluated
```

**Verification:**
- **TEST-HD-509 to 518** (10 co-occurrence tests)
  - TEST-HD-509: PLT ‚â•1000 + Neutrofilia
  - TEST-HD-510: TMA + Anemia grave
  - TEST-HD-511: CIVD + Neutropenia
  - TEST-HD-512 to 518: Additional co-occurrence scenarios
- **Red List impact:** S-THROMBOCITOSE-CRIT FN 22/30 ‚Üí 0/30 (fixed!)
- **Implementation:** `src/hemodoctor/engines/syndrome.py:detect_syndromes()`

**Risk Controls:**
- RISK-HD-050: Multi-critical co-occurrence not detected ‚≠ê NEW

**IFU:** IFU-001 ¬ß3.2 (Multiple critical syndromes reported)

**PMS:** PMS-001 ¬ß4.3 (Co-occurrence patterns monitoring)

**Status:** ‚úÖ IMPLEMENTED (Sprint 4, 22 Oct 2025)

**Note:** This requirement **SUPERSEDES REQ-HD-013** for critical syndromes only.

---

### REQ-HD-035: Performance ‚â§100ms Latency (Target: <50ms)

**Priority:** HIGH
**Description:** Guarantee pipeline latency ‚â§100ms per case (V0 target: <50ms achieved)

**Design:**
- SDD-001 ¬ß6 (Performance architecture)
- SDD-001 ¬ß4.3.3 (Short-circuit optimization)

**Performance Achieved (Sprint 2, 22 Oct 2025):**
- **Latency:** 2.5ms avg (TARGET: <100ms) = **40x BETTER!** üèÜ
- **Throughput:** ~1400 cases/hour (TARGET: >1000/h) = 40% above
- **Memory:** <10MB single case, <50MB batch 100
- **CPU:** Reasonable (<200%)

**Verification:**
- **TEST-HD-519 to 528** (10 performance tests)
  - TEST-HD-519 to 522: Latency (single, critical, complete, minimal CBC)
  - TEST-HD-523 to 524: Throughput (batch 100, batch 1000)
  - TEST-HD-525 to 526: Memory (single case, batch 100)
  - TEST-HD-527: CPU usage
  - TEST-HD-528: Concurrent load (20 requests)
- **Implementation:** `tests/integration/test_performance.py`
- **Report:** `PERFORMANCE_BENCHMARK_REPORT.md`

**Risk Controls:**
- RISK-HD-PERF-001: Latency degradation
- NFR-001: Performance baseline

**IFU:** IFU-001 ¬ß5 (Performance specifications)

**PMS:** PMS-001 ¬ß6 (Performance monitoring)

**Status:** ‚úÖ IMPLEMENTED (Sprint 2, 22 Oct 2025)

---

## NEW RISKS (2 total)

### RISK-HD-050: Multiple Critical Syndromes Co-occurrence Not Detected

**Category:** Clinical Decision Error
**Severity:** MEDIUM (before mitigation)
**Probability:** Medium (5-10% of critical cases)
**Residual Risk:** LOW (after Solution 2)

**Description:** Before Solution 2 (Sprint 4), system short-circuited after first critical syndrome, missing co-occurring critical conditions requiring simultaneous management.

**Clinical Example:**
- CBC: PLT=1997 (thrombocytosis) + WBC=35, ANC=28 (neutrofilia)
- Before Solution 2: Only S-THROMBOCITOSE-CRIT detected
- After Solution 2: Both S-THROMBOCITOSE-CRIT + S-NEUTROFILIA-LEFTSHIFT-CRIT detected ‚úÖ

**Red List Impact:**
- Before: S-THROMBOCITOSE-CRIT FN=22/30 (73% failure)
- After: S-THROMBOCITOSE-CRIT FN=0/30 (100% success) ‚úÖ

**Controlled By:**
- REQ-HD-034: Multiple Critical Syndromes Support (Solution 2)

**Verification:**
- TEST-HD-509 to 518: Co-occurrence tests (10 tests)
- Red List: tests/clinical/test_red_list_validation.py (240 cases, FN=0)

**Status:** ‚úÖ **MITIGATED** (Sprint 4, 22 Oct 2025)

**Residual Risk Level:** LOW √ó LOW = ACCEPTABLE

---

### RISK-HD-051: Timezone Comparison Bug in purge_old_logs()

**Category:** Data Management Error
**Severity:** MEDIUM (before fix)
**Probability:** Low (purge runs monthly, detected in testing)
**Residual Risk:** NEGLIGIBLE (after 5-min fix)

**Description:** `purge_old_logs()` compares naive datetime (filename) with timezone-aware datetime (now()), causing TypeError and preventing automated WORM log purge.

**Technical Issue:**
```python
# BROKEN (src/hemodoctor/engines/worm_log.py:297):
file_date = datetime.strptime(date_str, "%Y-%m-%d")  # Naive
cutoff_date = datetime.now(timezone.utc) - timedelta(days=1825)  # Aware
if file_date < cutoff_date:  # ‚ùå TypeError!

# FIXED (1-line change):
file_date = datetime.strptime(date_str, "%Y-%m-%d").replace(tzinfo=timezone.utc)  # Aware
```

**Impact:**
- Automated purge fails ‚Üí retention policy (1825 days) not enforced programmatically
- LGPD compliance risk (data minimization)
- Manual workaround available (admin can delete old logs)

**Controlled By:**
- REQ-HD-029: Retention policy (1825 days ANVISA/FDA)

**Verification:**
- TEST-HD-130 to 134: Purge tests (6 tests)
- Currently: 6/40 purge tests skipped (TypeError)
- After fix: 40/40 purge tests passing ‚úÖ

**Status:** ‚ö†Ô∏è **OPEN** (Fix pending Sprint 6 - 5 min effort)

**Residual Risk Level (after fix):** NEGLIGIBLE √ó LOW = ACCEPTABLE

---

## UPDATED TRACEABILITY TOTALS (v2.2)

| Metric | v2.1 | v2.2 | Change |
|--------|------|------|--------|
| **Total Requirements** | 32 | **35** | +3 |
| **Total Hazards** | 49 | **51** | +2 |
| **Total Tests** | 626 | **866** | +240 |
| **Traceability Entries** | 32 | 35 | +3 |
| **Coverage Completeness** | 100% | 100% | ‚úÖ |

**Test Breakdown v2.2:**
- Core tests: 362 (Sprint 0)
- Security tests: 104 (Sprint 1)
- Integration tests: 100 (Sprint 2)
- Audit tests: 60 (Sprint 3)
- **Red List tests: 240 (Sprint 4)** ‚≠ê NEW
- **Total: 866 tests** (pass rate: 851/866 = 98.3%)

**Coverage:** 89.01% (>85% threshold) ‚úÖ

---

## REQUIREMENTS ‚Üí RISKS MAPPING (Updated)

| Requirement | Risks Controlled | Count |
|-------------|------------------|-------|
| REQ-HD-033 | RISK-HD-001, RISK-HD-018, RISK-HD-050 | 3 ‚≠ê |
| REQ-HD-034 | RISK-HD-050 | 1 ‚≠ê |
| REQ-HD-035 | RISK-HD-PERF-001, NFR-001 | 2 ‚≠ê |

---

## RISKS ‚Üí REQUIREMENTS MAPPING (Updated)

| Risk ID | Controlled By Requirements | Residual Risk |
|---------|----------------------------|---------------|
| RISK-HD-050 | REQ-HD-034, REQ-HD-033 | LOW ‚≠ê |
| RISK-HD-051 | REQ-HD-029 | NEGLIGIBLE ‚≠ê |

---

**END OF NEW ENTRIES**

**Total additions:** 3 requirements + 2 risks + 240 tests
**Version:** v2.2
**Date:** 23 Oct 2025
**Sprint:** Sprint 5 Day 4
