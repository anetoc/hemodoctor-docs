# SDD-001 v2.2 - PATCH: Solution 2 Algorithm

**Section to update:** §4.3.3 Short-Circuit Critical Syndromes
**Action:** REPLACE entire section with this content

---

#### 4.3.3 Multiple Critical Syndromes Support (Solution 2)

**Change:** Sprint 4 (22 Oct 2025) - Solution 2 implementation
**Previous behavior (v2.1):** Short-circuit after FIRST critical syndrome
**New behavior (v2.2):** Allow MULTIPLE critical syndromes, THEN short-circuit

**Rationale:**
- **Clinical reality:** Patients can have multiple critical conditions simultaneously
- **Example:** PLT 1997 (thrombocytosis) + WBC 35 (neutrofilia/infection)
- **Before Solution 2:** Only first critical returned (short-circuit stopped evaluation)
- **After Solution 2:** ALL co-occurring critical syndromes detected ✅

**Algorithm (Solution 2):**
```python
def detect_syndromes(evidences: list[Evidence], config: Config) -> list[Syndrome]:
    """
    Detect syndromes with Solution 2 algorithm.

    Changes (22 Oct 2025):
    - Removed short-circuit DURING critical evaluation
    - Short-circuit AFTER all critical syndromes evaluated
    - Maintains deterministic precedence for tie-breaking
    """
    detected = []

    # Get sorted syndromes by precedence (critical first)
    sorted_syndromes = sorted(
        config.syndromes,
        key=lambda s: (0 if s.criticality == "critical" else 1, s.id)
    )

    for syndrome_def in sorted_syndromes:
        # Evaluate syndrome (all/any/negative logic)
        syndrome = evaluate_syndrome(syndrome_def, evidences)

        if syndrome.status == "present":
            detected.append(syndrome)

            # Short-circuit AFTER all critical syndromes
            if syndrome.criticality == "critical":
                # Check if more critical syndromes remain
                remaining_critical = [
                    s for s in sorted_syndromes
                    if s.criticality == "critical"
                    and s.id not in [d.id for d in detected]
                ]

                if not remaining_critical:
                    # All critical evaluated, safe to stop
                    break

    return detected
```

**Example:**
```python
# Input CBC
CBC = {
    "plt": 1997,  # ≥1000 = S-THROMBOCITOSE-CRIT
    "wbc": 35,    # >30 = neutrofilia
    "anc": 28     # >25 = S-NEUTROFILIA-LEFTSHIFT-CRIT
}

# Before Solution 2 (v2.1 short-circuit):
top_syndromes = ["S-THROMBOCITOSE-CRIT"]  # Short-circuit stopped here

# After Solution 2 (v2.2):
top_syndromes = [
    "S-THROMBOCITOSE-CRIT",  # First critical
    "S-NEUTROFILIA-LEFTSHIFT-CRIT"  # Second critical also detected ✅
]
```

**Red List Impact:**
- **Before Solution 2:** S-THROMBOCITOSE-CRIT FN=22/30 (73% FAILURE!)
- **After Solution 2:** S-THROMBOCITOSE-CRIT FN=0/30 (100% SUCCESS!) ✅

**Design Decision:**
- **Priority syndromes:** Still short-circuit after first (unchanged)
- **Routine syndromes:** Still short-circuit after first (unchanged)
- **Critical syndromes:** Allow multiple, THEN short-circuit (NEW)

**Traceability:**
- Requirement: REQ-HD-034 (Multiple Critical Syndromes Support)
- Hazard: RISK-HD-050 (Co-occurrence not detected)
- Tests: `tests/clinical/test_red_list_validation.py` (240 cases, all FN=0)
- Implementation: `src/hemodoctor/engines/syndrome.py:detect_syndromes()`

**Note:** This behavior **SUPERSEDES** previous short-circuit design (v2.1 §4.3.3) for **critical syndromes only**.

---

**PATCH END**

Apply this patch by replacing §4.3.3 in SDD-001_v2.2_SPRINT_0-4_ALIGNED.md with above content.
