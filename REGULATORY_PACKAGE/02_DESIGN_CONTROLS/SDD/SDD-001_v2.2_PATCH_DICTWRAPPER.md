# SDD-001 v2.2 - PATCH: DictWrapper

**Section to add:** §4.2.4.1 (NEW section after §4.2.4 Evidence Evaluation Engine)
**Action:** INSERT this new section

---

#### 4.2.4.1 DictWrapper for Morphology Dot Notation (NEW)

**Change:** Sprint 0 (21 Oct 2025) - BUG-014 fix
**Purpose:** Enable dot notation for nested dictionary fields (e.g., `morphology.esquistocitos`)

**Problem:**
Evidence rules use dot notation in YAML (e.g., `morphology.esquistocitos == true`), but Python dictionaries don't support attribute access naturally.

**Solution:** DictWrapper class

**Implementation:**
```python
class DictWrapper:
    """
    Wrapper to allow dot notation access to dictionary fields.

    Usage:
        morphology = DictWrapper({"esquistocitos": True})
        morphology.esquistocitos  # Returns True
    """
    def __init__(self, data: dict):
        self._data = data

    def __getattr__(self, key: str):
        """Allow attribute access: obj.key"""
        return self._data.get(key)

    def __contains__(self, key: str):
        """Allow 'in' operator: 'key' in obj"""
        return key in self._data

    def __getitem__(self, key: str):
        """Allow subscript access: obj['key']"""
        return self._data.get(key)
```

**Usage in Evidence Evaluation:**
```python
def evaluate_evidence(evidence_def: dict, cbc: dict, config: dict) -> Evidence:
    """
    Evaluate evidence rule with morphology support.

    Morphology fields are wrapped in DictWrapper to allow dot notation.
    """
    # Prepare names for safe eval (simpleeval)
    names = {
        "hb": cbc.get("hb"),
        "wbc": cbc.get("wbc"),
        "plt": cbc.get("plt"),
        # ... other fields
    }

    # Wrap morphology dict for dot notation support
    if "morphology" in cbc and isinstance(cbc["morphology"], dict):
        names["morphology"] = DictWrapper(cbc["morphology"])

    # Evaluate rule using simpleeval
    evaluator = EvalWithCompoundTypes(names=names)
    result = evaluator.eval(evidence_def["rule"])

    return Evidence(
        id=evidence_def["id"],
        status="present" if result else "absent"
    )
```

**Example:**
```python
# CBC input
cbc = {
    "plt": 8,
    "morphology": {
        "esquistocitos": True,
        "dacriocitos": False
    }
}

# Evidence rule (from 02_evidence_hybrid.yaml)
rule: "morphology.esquistocitos == true"

# Before DictWrapper:
# AttributeError: 'dict' object has no attribute 'esquistocitos'

# After DictWrapper:
names["morphology"] = DictWrapper(cbc["morphology"])
result = eval("morphology.esquistocitos == true")  # ✅ Works! Returns True
```

**Supported Evidence:**
- **E-SCHISTOCYTES-GE1PCT:** `morphology.esquistocitos == true`
- **E-DACRYOCYTES-PRESENT:** `morphology.dacriocitos == true`
- **E-SPHEROCYTES-PRESENT:** `morphology.esferocitos == true`
- **E-TARGET-CELLS-PRESENT:** `morphology.celulas_alvo == true`
- (All morphology-based evidences)

**Traceability:**
- Requirement: REQ-HD-009 (Handle morphology dot notation)
- Tests: `tests/unit/test_evidence_engine.py` (E-SCHISTOCYTES tests)
- Implementation: `src/hemodoctor/engines/evidence.py:DictWrapper`

**Note:** DictWrapper is a minimal wrapper for dot notation only. It does NOT modify the original dictionary.

---

**PATCH END**

Apply this patch by inserting §4.2.4.1 after §4.2.4 in SDD-001_v2.2_SPRINT_0-4_ALIGNED.md.
