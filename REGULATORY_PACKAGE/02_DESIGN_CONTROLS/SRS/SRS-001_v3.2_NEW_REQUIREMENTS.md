# SRS-001 v3.2 - NEW REQUIREMENTS ONLY

This file contains ONLY the new requirements to be added to SRS-001 v3.1 → v3.2

**To be inserted after REQ-HD-025 (line ~780)**

---

### 3.3 Audit & Traceability Requirements (REQ-HD-026 to REQ-HD-030)

#### REQ-HD-026: WORM Log (Append-Only, Immutable)

**Priority:** CRITICAL
**Source:** `08_wormlog_hybrid.yaml` v2.3.1
**Description:** Implement **WORM (Write-Once-Read-Many) audit log** for all clinical decisions with append-only immutable storage.

**WORM Log Requirements:**
- **Append-only:** Never update or delete entries (only append new events)
- **Immutable:** Log files read-only after creation
- **JSONL format:** One JSON event per line (parseable line-by-line)
- **Daily rotation:** New log file per day (`YYYY-MM-DD_hemodoctor_hybrid.jsonl`)
- **HMAC integrity:** Each event signed with HMAC-SHA256

**Log Entry Structure:**
```json
{
  "event_ts": "2025-10-22T12:34:56Z",
  "case_id_hash": "SHA256(case_id)",
  "site_id_hash": "SHA256(site_id)",
  "route_id": "SHA256(evidences+syndromes+output_class)",
  "top_syndromes": ["S-TMA", "S-PLT-CRITICA"],
  "fired_evidences": ["E-SCHISTOCYTES-GE1PCT", "E-PLT-CRIT-LOW"],
  "output_class": "critical",
  "version": "v2.4.0",
  "hmac_signature": "HMAC-SHA256(entry, kms_key)"
}
```

**Acceptance Criteria:**
- 100% audit coverage (every analyze_cbc() call logged)
- Zero lost events (append errors must retry)
- HMAC verification passes for all entries
- Daily rotation working (no single file >100MB)

**Verification:**
→ TEST-HD-095 to TEST-HD-134 (WORM log audit suite - 40 tests)
- Immutability tests (10)
- HMAC integrity tests (10)
- Pseudonymization tests (10)
- Retention tests (10)

**Traceability:**
→ `08_wormlog_hybrid.yaml` (lines 1-300)
→ `src/hemodoctor/engines/worm_log.py`
→ SDD-001 §4.6.1 (WORM log design)
→ RISK-HD-002 (Data corruption)
→ RISK-HD-021 (Incomplete audit trail)

---

#### REQ-HD-027: HMAC Integrity (SHA256)

**Priority:** CRITICAL
**Source:** `08_wormlog_hybrid.yaml` v2.3.1 lines 200-250
**Description:** Sign every WORM log entry with **HMAC-SHA256** for tamper detection.

**HMAC Requirements:**
- **Algorithm:** HMAC-SHA256
- **Key management:** KMS-backed secret key (AWS KMS, Azure Key Vault, or local env var)
- **Signature scope:** Entire log entry (all fields except hmac_signature itself)
- **Verification:** On read, verify HMAC before trusting data

**HMAC Computation:**
```python
import hmac
import hashlib

def compute_hmac(log_entry: dict, secret_key: str) -> str:
    """Compute HMAC-SHA256 for log entry"""
    # Remove hmac_signature from entry (if exists)
    entry_copy = {k: v for k, v in log_entry.items() if k != "hmac_signature"}

    # Serialize to canonical JSON (sorted keys)
    entry_json = json.dumps(entry_copy, sort_keys=True)

    # Compute HMAC
    signature = hmac.new(
        secret_key.encode(),
        entry_json.encode(),
        hashlib.sha256
    ).hexdigest()

    return signature
```

**Acceptance Criteria:**
- HMAC verification 100% pass rate (no tampered entries)
- KMS key rotation supported (re-sign with new key)
- Performance: HMAC compute + verify <1ms per entry

**Verification:**
→ TEST-HD-110 to TEST-HD-119 (HMAC tests)

**Traceability:**
→ RISK-HD-002 (Data corruption)
→ ANVISA RDC 657/2022 §15 (Audit trail integrity)
→ FDA 21 CFR Part 11 (Electronic signatures)

---

#### REQ-HD-028: Pseudonymization (Case ID / Site ID Hashing)

**Priority:** CRITICAL
**Source:** `08_wormlog_hybrid.yaml` v2.3.1 lines 100-150
**Description:** **Pseudonymize all patient identifiers** in WORM log using SHA256 hashing for LGPD compliance.

**Pseudonymization Rules:**
- **case_id:** SHA256(case_id) - never log raw patient ID
- **site_id:** SHA256(site_id) - never log raw site name
- **No PHI in logs:** No name, CPF, date of birth, address, etc.
- **Reversible only with key:** Pseudonymization key stored separately (not in code)

**Hashing Implementation:**
```python
import hashlib

def pseudonymize(identifier: str, salt: str = "") -> str:
    """SHA256 hash for pseudonymization"""
    salted = identifier + salt
    return hashlib.sha256(salted.encode()).hexdigest()

# Usage
case_id_hash = pseudonymize(case_id, salt=PSEUDONYM_SALT)
```

**LGPD Compliance:**
- **Art. 16:** Pseudonymization for data protection
- **Art. 46:** Retention policy (90 days for pseudonymized data, 1825 for audit)

**Acceptance Criteria:**
- Zero PHI in WORM logs (automated scan detects violations)
- SHA256 collision resistance (unique hashes for different IDs)
- Pseudonymization key separate from code (env var or KMS)

**Verification:**
→ TEST-HD-120 to TEST-HD-129 (Pseudonymization tests)

**Traceability:**
→ RISK-HD-004 (PHI exposure)
→ RISK-HD-032 (LGPD non-compliance)
→ LGPD Lei 13.709/2018

---

#### REQ-HD-029: Retention Policy (1825 Days = 5 Years)

**Priority:** HIGH
**Source:** `08_wormlog_hybrid.yaml` v2.3.1 lines 118-120
**Description:** Enforce **5-year retention policy** for WORM logs (ANVISA/FDA compliance).

**Retention Requirements:**
- **Retention period:** 1825 days (5 years) from log creation
- **Automated purge:** Monthly cron job deletes logs >1825 days old
- **Manual override:** Authorized user can extend retention (e.g., litigation hold)
- **Purge log:** Log all purge operations (which files deleted, when, by whom)

**Implementation:**
```python
from datetime import datetime, timedelta, timezone

def purge_old_logs(log_dir: str, retention_days: int = 1825):
    """Delete WORM log files older than retention_days"""
    cutoff_date = datetime.now(timezone.utc) - timedelta(days=retention_days)

    for log_file in os.listdir(log_dir):
        # Parse date from filename: YYYY-MM-DD_hemodoctor_hybrid.jsonl
        date_str = log_file.split("_")[0]
        file_date = datetime.strptime(date_str, "%Y-%m-%d").replace(tzinfo=timezone.utc)

        if file_date < cutoff_date:
            os.remove(os.path.join(log_dir, log_file))
            log_purge_event(log_file, file_date, cutoff_date)
```

**Regulatory Compliance:**
- **ANVISA RDC 657/2022:** 5-year retention for SaMD audit logs
- **FDA 21 CFR Part 11:** Electronic records retention
- **LGPD Art. 16:** Data minimization (delete after purpose fulfilled)

**Acceptance Criteria:**
- Automated purge working (no logs >1825 days in production)
- Purge log complete (all deletions audited)
- Manual override functional (authorized users can extend)

**Verification:**
→ TEST-HD-130 to TEST-HD-134 (Retention tests)
→ **Note:** 6 tests currently skipped due to timezone bug (RISK-HD-051)

**Traceability:**
→ RISK-HD-031 (Retention policy non-compliance)
→ RISK-HD-051 (Timezone bug - to be fixed Sprint 5)

---

#### REQ-HD-030: Route ID Determinism (SHA256)

**Priority:** HIGH
**Source:** `06_route_policy_hybrid.yaml` v2.3.1 lines 50-100
**Description:** Generate **deterministic route ID** using SHA256(evidences + syndromes + output_class) for reproducibility.

**Route ID Purpose:**
- **Reproducibility:** Same CBC + same version → same route_id
- **Traceability:** Track decision path from input to output
- **Regression testing:** Detect unintended algorithm changes
- **Alternative routes:** Document other plausible paths (future enhancement)

**Route ID Computation:**
```python
import hashlib
import json

def compute_route_id(evidences: list, syndromes: list, output_class: str, version: str) -> str:
    """Deterministic SHA256 route ID"""
    route_data = {
        "evidences": sorted(evidences),  # Sort for determinism
        "syndromes": sorted(syndromes),
        "output_class": output_class,
        "version": version
    }

    route_json = json.dumps(route_data, sort_keys=True)
    route_id = hashlib.sha256(route_json.encode()).hexdigest()

    return route_id
```

**Determinism Requirements:**
- **Same input → same route_id** (100% reproducible)
- **Different input → different route_id** (collision resistance)
- **Version-sensitive:** Different algorithm version → different route_id
- **Insensitive to case_id:** Pseudonymization independent

**Acceptance Criteria:**
- 100% determinism (10 runs → 10 identical route_ids)
- Collision resistance (1M random CBCs → 1M unique route_ids)
- Route ID format: 64-char hex (SHA256 standard)

**Verification:**
→ TEST-HD-135 to TEST-HD-154 (Route ID tests - 20 total)
- Determinism tests (10)
- Collision resistance tests (5)
- Traceability tests (5)

**Traceability:**
→ `06_route_policy_hybrid.yaml`
→ `src/hemodoctor/api/pipeline.py:compute_route_id()`
→ SDD-001 §4.6.5 (Route ID design)
→ RISK-HD-022 (Configuration drift)

---

### 3.4 Security & Performance Requirements (REQ-HD-031 to REQ-HD-032)

#### REQ-HD-031: Security Compliance (OWASP Top 10 2021)

**Priority:** CRITICAL
**Source:** Security best practices, IEC 62304 Class C
**Description:** Implement comprehensive security controls covering **OWASP Top 10 2021** vulnerabilities.

**OWASP Top 10 Coverage:**

1. **A01 Broken Access Control**
   - Mitigation: API authentication + authorization
   - Tests: `test_security_authentication.py` (20 tests)

2. **A02 Cryptographic Failures**
   - Mitigation: HTTPS only, HMAC-SHA256, pseudonymization
   - Tests: `test_security_data_protection.py` (25 tests)

3. **A03 Injection**
   - Mitigation: Safe eval (simpleeval), parameterized queries, input validation
   - Tests: `test_security_injection.py` (15 tests)

4. **A04 Insecure Design**
   - Mitigation: Threat modeling, secure SDLC, design reviews
   - Tests: Security architecture review

5. **A05 Security Misconfiguration**
   - Mitigation: Secure defaults, hardened Docker, environment variables
   - Tests: `test_security_config.py` (10 tests)

6. **A06 Vulnerable Components**
   - Mitigation: SBOM, automated vulnerability scanning, dependency updates
   - Tests: `test_security_sbom.py` (5 tests)

7. **A07 Identification Failures**
   - Mitigation: Strong authentication, session management, multi-factor (future)
   - Tests: `test_security_authentication.py` (auth tests)

8. **A08 Software Integrity Failures**
   - Mitigation: Code signing, SBOM, CI/CD integrity
   - Tests: `test_security_integrity.py` (5 tests)

9. **A09 Logging Failures**
   - Mitigation: WORM log, HMAC signatures, comprehensive audit
   - Tests: `test_worm_audit.py` (40 tests)

10. **A10 SSRF**
    - Mitigation: Input validation, whitelist external calls
    - Tests: `test_security_ssrf.py` (10 tests)

**Acceptance Criteria:**
- OWASP Top 10 2021: 100% coverage (10/10 categories)
- Zero CRITICAL vulnerabilities in production
- Security tests: 104 total (100% passing)
- Automated security scanning in CI/CD

**Verification:**
→ TEST-HD-155 to TEST-HD-258 (Security suite - 104 tests)

**Traceability:**
→ All `tests/security/test_security_*.py` modules
→ SDD-001 §4.7.1 (Security architecture)
→ RISK-HD-003 (Code injection)
→ RISK-HD-016 to RISK-HD-020 (Security hazards)
→ IEC 62304 §7.1 (Risk control measures)

---

#### REQ-HD-032: Performance Target (<100ms Pipeline Latency)

**Priority:** HIGH
**Source:** Clinical usability requirements
**Description:** Achieve **pipeline latency <100ms per case** (P50) and **throughput >1000 cases/hour** for clinical point-of-care use.

**Performance Targets:**
- **Latency (P50):** <100ms per case
- **Latency (P99):** <500ms per case
- **Throughput:** >1000 cases/hour (single instance)
- **Memory:** <50MB per batch (100 cases)
- **CPU:** Reasonable (<200% per core)
- **Concurrent load:** 20 requests <5s

**Achieved Performance (Sprint 2 - 22 Oct 2025):**
- ✅ **Latency (P50): 2.5ms avg** (40x BETTER than 100ms target!)
- ✅ **Throughput: ~1400 cases/hour** (40% above 1000/h target)
- ✅ **Memory: <10MB single case, <50MB batch 100**
- ✅ **CPU: Reasonable (<200%)**
- ✅ **Concurrent: 20 requests in <5s**

**Performance Optimization Strategies:**
- **Short-circuit:** Stop after first critical syndrome (when appropriate)
- **Lazy loading:** Load YAMLs once at startup, cache in memory
- **Compiled regex:** Pre-compile all regex patterns
- **Vectorization:** Batch operations where possible (future enhancement)

**Acceptance Criteria:**
- Latency target MET or EXCEEDED
- Throughput target MET or EXCEEDED
- Benchmark tests passing (pytest-benchmark)
- Memory profiling shows no leaks

**Verification:**
→ TEST-HD-259 to TEST-HD-268 (Performance suite - 10 tests)
- Latency tests (4)
- Throughput tests (2)
- Memory tests (2)
- CPU test (1)
- Concurrent load test (1)

**Traceability:**
→ `tests/integration/test_performance.py`
→ SDD-001 §4.7.2 (Performance optimization)
→ RISK-HD-015 (Performance degradation)

---

### 3.5 Red List & Clinical Validation Requirements (REQ-HD-033 to REQ-HD-035)

#### REQ-HD-033: Red List FN=0 Validation (240 Test Cases)

**Priority:** CRITICAL
**Source:** ANVISA Class III gate requirement, Sprint 4 (22 Oct 2025)
**Description:** Guarantee **FN=0 (zero false negatives)** for 8 critical syndromes through dedicated validation with 240 minimum test cases.

**Rationale:** ANVISA Class III SaMD MUST NOT miss critical conditions - false negative on critical syndrome = patient harm.

**Critical Syndromes (8 total):**
1. **S-NEUTROPENIA-GRAVE** (ANC <0.5) - Infection risk, sepsis
2. **S-BLASTIC-SYNDROME** (blasts present) - Acute leukemia
3. **S-TMA** (schistocytes + PLT <30) - Microangiopathic hemolysis
4. **S-PLT-CRITICA** (PLT <20) - Bleeding risk
5. **S-ANEMIA-GRAVE** (Hb <6.5 M / <6.0 F) - Severe anemia
6. **S-NEUTROFILIA-LEFTSHIFT-CRIT** - Severe infection/sepsis
7. **S-THROMBOCITOSE-CRIT** (PLT ≥1000) - Thrombosis risk
8. **S-CIVD** (≥2 DIC markers) - Disseminated intravascular coagulation

**Red List Validation Protocol:**
- **Minimum 30 cases per syndrome** (240 total)
- **Blind adjudication by 2 hematologists** (independent gold standard)
- **Sensitivity target: 100%** (FN=0 mandatory)
- **Validation dataset independent** from training/tuning

**Validation Results (Sprint 4 - 22 Oct 2025):**

| Syndrome | TP | FN | Sensitivity | Status |
|----------|----|----|-------------|--------|
| S-NEUTROPENIA-GRAVE | 30 | **0** | **100%** | ✅ |
| S-BLASTIC-SYNDROME | 30 | **0** | **100%** | ✅ |
| S-TMA | 30 | **0** | **100%** | ✅ |
| S-PLT-CRITICA | 30 | **0** | **100%** | ✅ |
| S-ANEMIA-GRAVE | 30 | **0** | **100%** | ✅ |
| S-NEUTROFILIA-LEFTSHIFT-CRIT | 30 | **0** | **100%** | ✅ |
| S-THROMBOCITOSE-CRIT | 30 | **0** | **100%** | ✅ (Solution 2) |
| S-CIVD | 30 | **0** | **100%** | ✅ (Solution 2) |
| **TOTAL** | **240** | **0** | **100%** | ✅ **GATE PASSED** |

**Acceptance Criteria:**
- **FN=0 for ALL 8 critical syndromes** (mandatory)
- Sensitivity ≥99% (100% achieved)
- Blind adjudication complete (2 hematologists)
- Validation dataset documented (case_id, CBC, gold standard)

**Verification:**
→ TEST-HD-269 to TEST-HD-508 (Red List validation - 240 tests)
→ `tests/clinical/test_red_list_validation.py`
→ `data/red_list/critical_cases.json` (240 cases)

**Traceability:**
→ RISK-HD-001 (False Negative critical syndrome)
→ RISK-HD-005 to RISK-HD-009 (Individual critical syndromes)
→ `RED_LIST_VALIDATION_REPORT.md` (Sprint 4 deliverable)
→ `CLINICAL_EVIDENCE_PACKAGE.md` (Hematologist approval)

---

#### REQ-HD-034: Multiple Critical Syndromes Support (Solution 2)

**Priority:** HIGH
**Source:** Sprint 4 (22 Oct 2025) - Emergent fix for S-THROMBOCITOSE-CRIT FN
**Description:** Detect and report **multiple critical syndromes when co-occurring** (e.g., PLT ≥1000 + neutrofilia), instead of short-circuiting after first critical.

**Rationale:**
- **Clinical reality:** Patients can have multiple critical conditions simultaneously
- **Example:** PLT 1997 (thrombocytosis) + WBC 35 (neutrofilia/infection)
- **Before Solution 2:** Only first critical reported (short-circuit stopped evaluation)
- **After Solution 2:** All co-occurring critical syndromes detected ✅

**Solution 2 Algorithm:**
```python
def detect_syndromes(evidences, config):
    """
    Solution 2: Detect ALL critical syndromes, THEN short-circuit.

    Changes (22 Oct 2025):
    - Removed short-circuit DURING critical evaluation
    - Short-circuit AFTER all critical syndromes evaluated
    - Maintains deterministic precedence for tie-breaking
    """
    detected = []

    # Evaluate ALL syndromes (critical first by precedence)
    for syndrome_def in sorted_by_precedence(config.syndromes):
        syndrome = evaluate_syndrome(syndrome_def, evidences)
        if syndrome.status == "present":
            detected.append(syndrome)

            # Short-circuit AFTER all critical syndromes
            if syndrome.criticality == "critical":
                # Check if more critical syndromes in queue
                remaining_critical = [s for s in config.syndromes
                                     if s.criticality == "critical"
                                     and s.id not in [d.id for d in detected]]
                if not remaining_critical:
                    break  # All critical evaluated, stop

    return detected
```

**Example:**
```python
CBC = {
    "plt": 1997,  # ≥1000 = S-THROMBOCITOSE-CRIT
    "wbc": 35,    # >30 = neutrofilia
    "anc": 28     # >25 = leftshift critical
}

# Before Solution 2 (REQ-HD-013 short-circuit):
top_syndromes = ["S-THROMBOCITOSE-CRIT"]  # Short-circuit stopped

# After Solution 2 (REQ-HD-034):
top_syndromes = ["S-THROMBOCITOSE-CRIT", "S-NEUTROFILIA-LEFTSHIFT-CRIT"]  # Both detected ✅
```

**Red List Impact:**
- **Before Solution 2:** S-THROMBOCITOSE-CRIT FN=22/30 (73% failure!)
- **After Solution 2:** S-THROMBOCITOSE-CRIT FN=0/30 (100% success!) ✅

**Acceptance Criteria:**
- All co-occurring critical syndromes detected
- Deterministic ordering maintained (precedence rules)
- Red List validation still FN=0

**Verification:**
→ TEST-HD-509 to TEST-HD-518 (Solution 2 co-occurrence tests - 10 tests)
→ `tests/integration/test_syndrome.py::test_multiple_critical_syndromes`

**Traceability:**
→ RISK-HD-050 (Multiple critical syndromes co-occurrence)
→ `src/hemodoctor/engines/syndrome.py:detect_syndromes()`
→ SDD-001 §4.3.3.1 (Solution 2 algorithm)

**Note:** This requirement **SUPERSEDES REQ-HD-013** (short-circuit behavior) for **critical syndromes only**. Priority and routine syndromes still short-circuit after first detection.

---

#### REQ-HD-035: Performance Benchmarking & Documentation

**Priority:** MEDIUM
**Source:** Sprint 2 (22 Oct 2025) - Performance validation
**Description:** Benchmark and document **exceptional performance achieved** (2.5ms avg vs 100ms target = 40x better).

**Performance Benchmarks:**

| Metric | Target | Achieved | Status |
|--------|--------|----------|--------|
| **Latency (P50)** | <100ms | **2.5ms avg** | ✅ **40x BETTER** |
| **Latency (P99)** | <500ms | **5ms** | ✅ **100x BETTER** |
| **Throughput** | >1000/h | **~1400/h** | ✅ **40% ABOVE** |
| **Memory (single)** | <50MB | **<10MB** | ✅ **5x BETTER** |
| **Memory (batch 100)** | <50MB | **<50MB** | ✅ **MET** |
| **CPU** | <200% | **<150%** | ✅ **BELOW** |
| **Concurrent (20 req)** | <10s | **<5s** | ✅ **2x BETTER** |

**Performance Optimization Techniques:**
1. **Lazy YAML loading:** Load once at startup, cache in memory
2. **Short-circuit (priority/routine):** Stop after first non-critical syndrome
3. **Solution 2 (critical only):** Allow multiple critical, then short-circuit
4. **Compiled regex:** Pre-compile all evidence rule patterns
5. **Safe eval optimization:** simpleeval with minimal overhead
6. **Deterministic routing:** Single-pass SHA256 computation

**Acceptance Criteria:**
- All benchmark tests passing (pytest-benchmark)
- Performance documented in validation reports
- No performance regressions in CI/CD (baseline: 2.5ms)

**Verification:**
→ TEST-HD-519 to TEST-HD-528 (Performance benchmarks - 10 tests)
→ `tests/integration/test_performance.py`
→ `PERFORMANCE_BENCHMARK_REPORT.md` (Sprint 2 deliverable)

**Traceability:**
→ REQ-HD-032 (Performance target - EXCEEDED)
→ RISK-HD-015 (Performance degradation - mitigated)
→ SDD-001 §4.7.2 (Performance optimization design)

---

**END OF NEW REQUIREMENTS**

Total new requirements: 10
- REQ-HD-026 to REQ-HD-030 (Audit & Traceability) - 5 requirements
- REQ-HD-031 to REQ-HD-032 (Security & Performance) - 2 requirements
- REQ-HD-033 to REQ-HD-035 (Red List & Validation) - 3 requirements

Total requirements in SRS v3.2: 35 (25 previous + 10 new)
