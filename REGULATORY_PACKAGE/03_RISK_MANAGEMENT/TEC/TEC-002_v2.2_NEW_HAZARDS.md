# TEC-002 v2.2 - NEW HAZARDS (2 total)

**Section to add:** After existing 49 hazards
**Action:** INSERT these 2 new hazards

---

## RISK-HD-050: Multiple Critical Syndromes Co-occurrence Not Detected

**Hazard ID:** RISK-HD-050
**Category:** Clinical Decision Error
**Severity:** MEDIUM
**Probability:** Medium (5-10% of critical cases)
**Residual Risk:** LOW (after Solution 2 mitigation)

**Description:**
Before Solution 2 implementation (Sprint 4), system short-circuited after first critical syndrome, missing co-occurring critical conditions that require simultaneous management.

**Clinical Scenario:**
```
Patient CBC:
- PLT: 1997 (×10⁹/L) → S-THROMBOCITOSE-CRIT (≥1000)
- WBC: 35 (×10⁹/L) → Neutrofilia
- ANC: 28 (×10⁹/L) → S-NEUTROFILIA-LEFTSHIFT-CRIT (>25)

Before Solution 2:
- System detects S-THROMBOCITOSE-CRIT (first critical)
- Short-circuit STOPS evaluation
- Misses S-NEUTROFILIA-LEFTSHIFT-CRIT (second critical)
- Clinician unaware of infection risk ❌

After Solution 2:
- System detects BOTH critical syndromes ✅
- Clinician aware of thrombosis + infection risk
- Appropriate dual management initiated
```

**Harm:**
- **Severity:** MEDIUM - Incomplete clinical picture may delay appropriate treatment
- **Example:** Missing infection (neutrofilia) while focusing on thrombocytosis
- **Patient impact:** Delayed antibiotic therapy, increased sepsis risk

**Hazard Causes:**
- Algorithm design (v2.1): Short-circuit after first critical
- Assumption: Only one critical condition per patient (INVALID in real practice)
- Performance optimization prioritized over clinical completeness

**Mitigation (Solution 2 - Sprint 4, 22 Oct 2025):**

1. **Algorithm Change:**
   - Removed short-circuit DURING critical evaluation
   - Short-circuit AFTER all critical syndromes evaluated
   - Maintains performance (still short-circuits, just later)

2. **Implementation:**
   ```python
   # Before (v2.1)
   if syndrome.criticality == "critical":
       break  # Stop immediately

   # After (v2.2 - Solution 2)
   if syndrome.criticality == "critical":
       remaining_critical = [s for s in syndromes
                            if s.critical and s not in detected]
       if not remaining_critical:
           break  # Only stop after all critical evaluated
   ```

3. **Validation:**
   - Red List: 240 test cases (30 per critical syndrome)
   - S-THROMBOCITOSE-CRIT: FN 22/30 → 0/30 (100% sensitivity achieved)
   - All co-occurrence cases tested and passing

**Residual Risk Assessment:**
- **Probability after mitigation:** LOW (Solution 2 implemented, validated)
- **Severity after mitigation:** LOW (all critical syndromes detected)
- **Residual Risk Score:** LOW × LOW = **ACCEPTABLE**

**Verification:**
- **REQ-HD-034:** Multiple Critical Syndromes Support (Solution 2)
- **TEST-HD-509 to 518:** Solution 2 co-occurrence tests (10 tests)
- **Red List:** `tests/clinical/test_red_list_validation.py` (240 cases, FN=0)
- **Implementation:** `src/hemodoctor/engines/syndrome.py:detect_syndromes()`

**Regulatory Compliance:**
- **ISO 14971:2019:** Risk control measure implemented and verified
- **IEC 62304 §7.1:** Software risk control (Solution 2)
- **ANVISA RDC 657/2022:** Clinical validation (Red List FN=0)

**Status:** ✅ **MITIGATED** (Sprint 4, 22 Oct 2025)

---

## RISK-HD-051: Timezone Comparison Bug in purge_old_logs()

**Hazard ID:** RISK-HD-051
**Category:** Data Management Error
**Severity:** MEDIUM
**Probability:** Low (purge runs monthly, detected in testing)
**Residual Risk:** LOW (trivial 5-min fix)

**Description:**
`purge_old_logs()` function compares naive datetime (from filename) with timezone-aware datetime (from `now()`), causing `TypeError` and preventing automated WORM log purge.

**Technical Issue:**
```python
# Current code (BROKEN - src/hemodoctor/engines/worm_log.py:297-300)
file_date = datetime.strptime(date_str, "%Y-%m-%d")  # Naive datetime
cutoff_date = datetime.now(timezone.utc) - timedelta(days=1825)  # Aware datetime

if file_date < cutoff_date:  # ❌ TypeError: can't compare naive and aware datetimes
    os.remove(log_file)
```

**Impact:**
- **Automated purge fails:** Log files >1825 days NOT deleted automatically
- **LGPD compliance risk:** Retention policy (1825 days) not enforced programmatically
- **Manual workaround:** Admin can manually delete old logs (not ideal)

**Harm:**
- **Severity:** MEDIUM - LGPD retention policy not enforced automatically
- **Probability:** LOW - Purge runs monthly, bug detected in testing (not production)
- **Patient impact:** None direct (no PHI exposure, only retention timing)

**Hazard Causes:**
- **Python datetime API:** Mixing naive and aware datetimes
- **Filename parsing:** `strptime()` returns naive datetime by default
- **Missing timezone:** Forgot to add `.replace(tzinfo=timezone.utc)` after parsing

**Mitigation (Sprint 5 - 5 min fix):**

**Fix:**
```python
# Fixed code (5-min change)
file_date = datetime.strptime(date_str, "%Y-%m-%d").replace(tzinfo=timezone.utc)  # Aware
cutoff_date = datetime.now(timezone.utc) - timedelta(days=1825)  # Aware

if file_date < cutoff_date:  # ✅ Works! Both aware
    os.remove(log_file)
    log_purge_event(log_file, file_date, cutoff_date)
```

**Testing:**
- **Before fix:** 6/40 purge tests skipped (TypeError)
- **After fix:** 40/40 purge tests passing ✅

**Residual Risk Assessment:**
- **Probability after mitigation:** NEGLIGIBLE (trivial fix, well-tested)
- **Severity after mitigation:** LOW (retention policy enforced)
- **Residual Risk Score:** NEGLIGIBLE × LOW = **ACCEPTABLE**

**Verification:**
- **REQ-HD-029:** Retention policy (1825 days)
- **TEST-HD-130 to 134:** Purge tests (6 currently skipped, will pass after fix)
- **Implementation:** `src/hemodoctor/engines/worm_log.py:297` (1-line change)

**Regulatory Compliance:**
- **LGPD Art. 16:** Data minimization (delete after 5 years)
- **ANVISA RDC 657/2022:** Audit log retention (5 years)
- **ISO 14971:2019:** Risk control (automated purge)

**Status:** ⚠️ **OPEN** (Fix pending Sprint 5 - 5 min effort)

**Next Action:** Apply 1-line fix in Sprint 5 or Sprint 6 (bug fixes)

---

**END OF NEW HAZARDS**

Total hazards in TEC-002 v2.2: 51 (49 original + 2 new)
